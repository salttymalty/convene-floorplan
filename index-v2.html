<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Convene Willis Tower — Floor Plan</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600&family=Source+Sans+3:wght@400;500;600&family=Source+Code+Pro:wght@400;500&display=swap');

  :root {
    /* ── Text Scale ── */
    --text:        #2c2825;
    --text-light:  #5c5550;
    --text-muted:  #8a8580;
    --ground:      #f7f5f2;
    --cream:       #f0ede8;
    --white:       #ffffff;
    --shadow-near: hsla(25, 40%, 30%, 0.06);
    --shadow-far:  hsla(25, 30%, 40%, 0.04);
    --radius:      12px;
    --radius-sm:   8px;

    /* ── Type Scale (12px floor for all HTML) ── */
    --type-xs:     0.75rem;    /* 12px — absolute floor, metadata only */
    --type-sm:     0.8125rem;  /* 13px — captions, labels, legend */
    --type-base:   0.875rem;   /* 14px — body text, item names, notes */
    --type-md:     1rem;        /* 16px — section labels, counts */
    --type-lg:     1.125rem;    /* 18px — room names, panel headers */
    --type-xl:     1.25rem;     /* 20px — page title */

    /* ── Spacing Scale ── */
    --space-2xs:   6px;
    --space-xs:    10px;
    --space-sm:    16px;
    --space-md:    24px;
    --space-lg:    40px;
    --space-xl:    64px;

    /* ── Room Fill Intensity (earth tone value ramp) ── */
    --room-empty:    #f0ece8;
    --room-light:    #e2d5c8;
    --room-moderate: #d4c0a8;
    --room-heavy:    #c4a888;
    --room-dense:    #b49068;

    /* ── Room Stroke (warm grays, matched to fills) ── */
    --stroke-empty:    #d4c8b8;
    --stroke-light:    #c4b8a4;
    --stroke-moderate: #b4a890;
    --stroke-heavy:    #a4987c;
    --stroke-dense:    #947c60;

    /* ── Status Colors (data encoding — three distinct hues) ── */
    --status-set:    #4a6b5c;   /* earth-moss — "set up" */
    --status-test:   #8a919e;   /* cool-400 — "tested" */
    --status-ready:  #c4704b;   /* warm-500 / terracotta — "ready/complete" */
    --status-flag:   #d45f47;   /* alert — the ONLY red-adjacent color */

    /* ── Setup Intensity Ramp (--status-set based) ── */
    --set-0-fill:    #f0ece8;
    --set-0-stroke:  #d4c8b8;
    --set-1-fill:    rgba(74, 107, 92, 0.10);
    --set-1-stroke:  rgba(74, 107, 92, 0.40);
    --set-2-fill:    rgba(74, 107, 92, 0.22);
    --set-2-stroke:  rgba(74, 107, 92, 0.58);
    --set-3-fill:    rgba(74, 107, 92, 0.36);
    --set-3-stroke:  rgba(74, 107, 92, 0.72);
    --set-4-fill:    rgba(74, 107, 92, 0.50);
    --set-4-stroke:  rgba(74, 107, 92, 0.88);

    /* ── Test Intensity Ramp (--status-test based) ── */
    --test-0-fill:   #f0ece8;
    --test-0-stroke: #d4c8b8;
    --test-1-fill:   rgba(138, 145, 158, 0.12);
    --test-1-stroke: rgba(138, 145, 158, 0.40);
    --test-2-fill:   rgba(138, 145, 158, 0.24);
    --test-2-stroke: rgba(138, 145, 158, 0.58);
    --test-3-fill:   rgba(138, 145, 158, 0.38);
    --test-3-stroke: rgba(138, 145, 158, 0.72);
    --test-4-fill:   rgba(138, 145, 158, 0.52);
    --test-4-stroke: rgba(138, 145, 158, 0.88);

    /* ── Accent (single color, selection/hover ONLY) ── */
    --accent:        #d4846a;   /* warm-300 — selected room highlight */
    --accent-hover:  rgba(212, 132, 106, 0.20);
    --accent-glow:   rgba(212, 132, 106, 0.35);

    /* ── Category Border Colors (section labels only) ── */
    --cat-audio:         #4a6b5c;
    --cat-video:         #6b7c8c;
    --cat-control:       #b4884a;
    --cat-presentation:  #c4704b;
    --cat-cables:        #8a9080;

    /* ── Type Badges ── */
    --badge-meeting:  #4a6b5c;
    --badge-studio:   #6b7c8c;
    --badge-service:  #b4a890;
    --badge-gallery:  #d4c8b8;

    /* ── Easing ── */
    --ease-smooth:  cubic-bezier(0.22, 0.61, 0.36, 1);
    --ease-spring:  cubic-bezier(0.34, 1.56, 0.64, 1);
    --ease-settle:  cubic-bezier(0.25, 0.46, 0.45, 0.94);

    /* ── Typography ── */
    --font-display: 'Fraunces', Georgia, serif;
    --font-body:    'Source Sans 3', system-ui, sans-serif;
    --font-mono:    'Source Code Pro', monospace;

    /* ── Sidebar Dimensions ── */
    --sidebar-collapsed:  280px;
    --sidebar-expanded:   420px;
    --sidebar-transition: 300ms;
  }

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--ground);
    color: var(--text);
    font-family: var(--font-body);
    line-height: 1.6;
    padding: var(--space-md);
  }

  /* ─── Page Layout ─── */
  .page { max-width: 1200px; margin: 0 auto; }

  header {
    display: flex; align-items: baseline; gap: 1rem;
    margin-bottom: 0.75rem; flex-wrap: wrap;
  }
  header h1 {
    font-family: var(--font-display); font-size: var(--type-xl); font-weight: 600;
  }
  header .addr {
    font-family: var(--font-mono); font-size: var(--type-sm); color: var(--text-muted);
  }

  /* ─── Toolbar ─── */
  .toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
    flex-wrap: wrap;
  }

  .day-switcher {
    display: flex;
    gap: var(--space-2xs);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .day-tab {
    font-family: var(--font-body);
    font-size: var(--type-sm);
    font-weight: 500;
    padding: 0.35rem 0.75rem;
    border: 1px solid var(--cream);
    border-radius: 20px;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .day-tab:hover {
    background: var(--cream);
    color: var(--text);
  }
  .day-tab.active {
    background: var(--status-ready);
    color: var(--white);
    border-color: var(--status-ready);
  }
  .day-tab .day-label {
    font-size: var(--type-xs);
    opacity: 0.8;
    margin-left: 0.3rem;
  }

  /* ─── Progress Rings ─── */
  .progress-rings {
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }
  .ring-group {
    display: flex;
    align-items: center;
    gap: 0.2rem;
  }
  .ring-wrap {
    width: 42px;
    height: 42px;
    position: relative;
  }
  .ring-wrap svg {
    transform: rotate(-90deg);
    width: 42px;
    height: 42px;
  }
  .ring-track {
    fill: none;
    stroke: var(--cream);
    stroke-width: 3;
  }
  .ring-fill {
    fill: none;
    stroke-width: 3;
    stroke-linecap: round;
    transition: stroke-dashoffset 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .ring-fill-set { stroke: var(--status-set); }
  .ring-fill-test { stroke: var(--status-test); }
  .ring-fill-ready { stroke: var(--status-ready); }
  .ring-pct {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    font-weight: 500;
    color: var(--text-light);
  }
  .ring-label {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    font-weight: 500;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    color: var(--text-muted);
  }

  .search-box {
    position: relative;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .search-box input {
    font-family: var(--font-mono);
    font-size: var(--type-sm);
    padding: 0.4rem 0.8rem;
    border: 1px solid var(--cream);
    border-radius: 20px;
    background: var(--white);
    color: var(--text);
    width: 190px;
    outline: none;
    transition: border-color 0.2s, width 0.3s;
  }
  .search-box input:focus {
    border-color: var(--accent-hover);
    width: 230px;
  }
  .search-box input::placeholder { color: var(--text-muted); }

  .search-count {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    color: var(--accent);
    opacity: 0;
    transition: opacity 0.2s;
    white-space: nowrap;
  }
  .search-count.visible { opacity: 1; }

  /* ─── Main Grid ─── */
  .plan-layout {
    display: grid;
    grid-template-columns: 1fr var(--sidebar-collapsed);
    gap: var(--space-md);
    align-items: start;
    transition: grid-template-columns var(--sidebar-transition) var(--ease-smooth);
  }

  .plan-layout.room-selected {
    grid-template-columns: 1fr var(--sidebar-expanded);
  }

  @media (max-width: 860px) {
    .plan-layout {
      grid-template-columns: 1fr;
    }
    .detail-panel {
      order: -1;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      border-radius: var(--radius) var(--radius) 0 0;
      z-index: 50;
      transform: translateY(calc(100% - 56px));
      transition: transform 0.3s var(--ease-smooth);
    }
    .detail-panel.sheet-intermediate {
      transform: translateY(50vh);
    }
    .detail-panel.sheet-expanded {
      transform: translateY(15vh);
    }
    .toolbar { flex-direction: column; align-items: stretch; }
    .search-box input { width: 100%; }
    .search-box input:focus { width: 100%; }
    .progress-rings { justify-content: center; }
  }

  /* ─── SVG Card ─── */
  .plan-card {
    background: var(--white);
    border-radius: var(--radius);
    box-shadow: 0 1px 3px var(--shadow-near), 0 8px 24px var(--shadow-far);
    padding: var(--space-md);
    overflow: hidden;
    position: relative;
  }
  .plan-card svg { width: 100%; height: auto; display: block; }

  /* ─── SVG Room Styles ─── */
  .building-outline {
    fill: none; stroke: var(--cream); stroke-width: 0.8;
  }
  .corridor {
    fill: rgba(232, 228, 224, 0.06); stroke: none;
  }

  .room {
    cursor: pointer;
    stroke-width: 0.6;
    transition: fill 0.4s ease, stroke 0.4s ease, filter 0.35s ease-out, stroke-width 0.25s ease, opacity 0.3s ease;
    transform-origin: center;
  }
  .room:hover {
    filter: brightness(0.94) drop-shadow(0 0 6px var(--accent-hover));
    stroke-width: 1.4;
  }
  .room:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
  .room.selected {
    stroke: var(--accent);
    stroke-width: 2.2;
    filter: drop-shadow(0 0 8px var(--accent-glow));
  }

  .room.i0 { fill: var(--room-empty); stroke: var(--stroke-empty); }
  .room.i1 { fill: var(--room-light); stroke: var(--stroke-light); }
  .room.i2 { fill: var(--room-moderate); stroke: var(--stroke-moderate); }
  .room.i3 { fill: var(--room-heavy); stroke: var(--stroke-heavy); }
  .room.i4 { fill: var(--room-dense); stroke: var(--stroke-dense); }

  /* Search states */
  .room.search-dim {
    opacity: 0.2;
  }
  .room.search-match {
    stroke: var(--accent) !important;
    stroke-width: 2 !important;
  }

  /* ─── SVG Status Bars ─── */
  .status-track-rect {
    fill: rgba(232, 228, 224, 0.5);
    pointer-events: none;
  }
  .status-set-rect {
    fill: var(--status-set);
    pointer-events: none;
    opacity: 0.85;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .status-test-rect {
    fill: var(--status-test);
    pointer-events: none;
    opacity: 0.85;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  #statusBars g {
    transition: opacity 0.4s ease;
  }

  /* ─── Animations ─── */
  @keyframes contentReveal {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  #detailContent.revealing > * {
    animation: contentReveal 250ms var(--ease-smooth) backwards;
  }
  #detailContent.revealing > :nth-child(1) { animation-delay: 0ms; }
  #detailContent.revealing > :nth-child(2) { animation-delay: 60ms; }
  #detailContent.revealing > :nth-child(3) { animation-delay: 120ms; }
  #detailContent.revealing > :nth-child(n+4) { animation-delay: 180ms; }

  @keyframes checkPop {
    0% { transform: scale(1); }
    35% { transform: scale(1.3); }
    65% { transform: scale(0.9); }
    100% { transform: scale(1); }
  }
  .check-box.popping {
    animation: checkPop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .divider-line {
    stroke: var(--stroke-empty); stroke-width: 0.5; stroke-dasharray: 3 2;
  }

  .label-room {
    font-family: 'Fraunces', serif;
    font-size: 12px; font-weight: 600;
    fill: var(--text); text-anchor: middle;
    pointer-events: none;
    dominant-baseline: central;
  }
  .label-room.sm { font-size: 10px; fill: var(--text-light); }
  .label-room.xs { font-size: 10px; fill: var(--text-muted); font-weight: 400; }

  .label-count {
    font-family: 'Source Code Pro', monospace;
    font-size: 10px; font-weight: 500;
    fill: var(--status-test); text-anchor: middle;
    pointer-events: none;
    dominant-baseline: central;
    transition: opacity 0.3s;
  }

  .label-sub {
    font-family: 'Source Sans 3', sans-serif;
    font-size: 9px; font-weight: 400;
    fill: var(--text-muted); text-anchor: middle;
    pointer-events: none;
    dominant-baseline: central;
  }

  .entrance-marker {
    fill: var(--accent); stroke: none; opacity: 0.6;
  }
  .entrance-label {
    font-family: 'Source Code Pro', monospace;
    font-size: 9px; fill: var(--text-muted);
    text-anchor: middle; letter-spacing: 0.5px;
  }

  /* ─── Legend ─── */
  .legend {
    display: flex; align-items: center; gap: 0.4rem;
    margin-top: 1rem; padding-top: 0.75rem;
    border-top: 1px solid var(--cream);
    flex-wrap: wrap;
  }
  .legend-title {
    font-family: var(--font-mono); font-size: var(--type-sm);
    color: var(--text-muted); text-transform: uppercase;
    letter-spacing: 0.06em; margin-right: 0.25rem;
  }
  .legend-step { display: flex; align-items: center; gap: 0.3rem; }
  .legend-swatch { width: 24px; height: 14px; border-radius: 3px; }
  .sw-0 { background: var(--room-empty); border: 1px solid var(--stroke-empty); }
  .sw-1 { background: var(--room-light); border: 1px solid var(--stroke-light); }
  .sw-2 { background: var(--room-moderate); border: 1px solid var(--stroke-moderate); }
  .sw-3 { background: var(--room-heavy); border: 1px solid var(--stroke-heavy); }
  .sw-4 { background: var(--room-dense); border: 1px solid var(--stroke-dense); }
  .legend-label { font-family: var(--font-body); font-size: var(--type-xs); color: var(--text-muted); }
  .legend-sep { color: var(--stroke-moderate); font-size: 0.65rem; margin: 0 0.1rem; }

  /* Legend mode toggle */
  .legend-modes {
    display: flex;
    gap: 0.2rem;
    margin-left: auto;
  }
  .legend-mode-btn {
    font-family: var(--font-mono);
    font-size: var(--type-sm);
    padding: 4px 10px;
    border: 1px solid var(--cream);
    border-radius: 10px;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  .legend-mode-btn:hover {
    background: var(--cream);
    color: var(--text);
  }
  .legend-mode-btn.active {
    background: var(--accent);
    color: var(--white);
    border-color: var(--accent);
  }

  /* ─── Detail Panel ─── */
  .detail-panel {
    background: var(--white);
    border-radius: var(--radius);
    box-shadow: 0 1px 3px var(--shadow-near), 0 8px 24px var(--shadow-far);
    padding: var(--space-md);
    position: sticky; top: 1.5rem;
    max-height: calc(100vh - 3rem);
    overflow-y: auto;
    width: var(--sidebar-collapsed);
    transition: width var(--sidebar-transition) var(--ease-smooth);
  }

  .detail-panel.expanded {
    width: var(--sidebar-expanded);
  }

  /* Panel tabs */
  .panel-tabs {
    display: flex;
    gap: 0.2rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--cream);
  }
  .panel-tab {
    font-family: var(--font-body);
    font-size: var(--type-sm);
    font-weight: 500;
    padding: 0.22rem 0.6rem;
    border: 1px solid transparent;
    border-radius: 6px;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
  }
  .panel-tab:hover {
    color: var(--text);
    background: rgba(232, 228, 224, 0.5);
  }
  .panel-tab.active {
    color: var(--text);
    background: var(--cream);
    border-color: rgba(0,0,0,0.04);
  }

  /* Room detail */
  .detail-empty {
    text-align: center; padding: 2rem 1rem;
    color: var(--text-muted); font-size: var(--type-base);
    line-height: 1.6;
  }
  .detail-empty .hint {
    display: block; margin-top: 0.4rem;
    font-size: var(--type-sm); opacity: 0.7;
  }

  .detail-header {
    font-family: var(--font-display);
    font-size: var(--type-lg); font-weight: 600;
    margin-bottom: var(--space-2xs); line-height: 1.3;
  }

  .detail-meta {
    display: flex; align-items: center; gap: 0.6rem;
    margin-bottom: 0.4rem; flex-wrap: wrap;
  }

  .detail-type {
    font-family: var(--font-mono); font-size: var(--type-xs);
    text-transform: uppercase; letter-spacing: 0.06em;
    padding: 0.15rem 0.55rem; border-radius: 10px;
    color: var(--white);
  }
  .dt-meeting { background: var(--badge-meeting); }
  .dt-studio { background: var(--badge-studio); }
  .dt-service { background: var(--badge-service); }
  .dt-gallery { background: var(--badge-gallery); color: var(--text-light); }

  .detail-count {
    font-family: var(--font-mono); font-size: var(--type-sm);
    color: var(--text-muted);
  }

  /* Tags row */
  .detail-tags {
    display: flex;
    gap: 0.2rem;
    flex-wrap: wrap;
    margin-bottom: 0.5rem;
  }
  .detail-tag {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    font-weight: 500;
    padding: 3px 8px;
    border-radius: 4px;
  }
  .tag-crew { background: rgba(180, 136, 74, 0.08); color: var(--cat-control); }
  .tag-zoom { background: rgba(74, 107, 92, 0.08); color: var(--cat-audio); }
  .tag-vendor { background: rgba(212, 95, 71, 0.06); color: var(--status-flag); }
  .tag-day { background: var(--cream); color: var(--text-light); }

  .detail-crew {
    font-family: var(--font-mono);
    font-size: var(--type-sm);
    color: var(--text-light);
    margin-bottom: 0.5rem;
  }

  .detail-section-label {
    font-family: var(--font-display); font-weight: 600;
    font-size: var(--type-sm); color: var(--text-light);
    text-transform: uppercase; letter-spacing: 0.04em;
    margin: var(--space-md) 0 var(--space-xs);
    padding-left: var(--space-sm);
    border-left: 3px solid var(--cream);
  }
  .detail-section-label.cat-audio { border-color: var(--cat-audio); }
  .detail-section-label.cat-video { border-color: var(--cat-video); }
  .detail-section-label.cat-control { border-color: var(--cat-control); }
  .detail-section-label.cat-presentation { border-color: var(--cat-presentation); }
  .detail-section-label.cat-cables { border-color: var(--cat-cables); }

  /* ─── Checklist Rows ─── */
  .checklist-row {
    display: grid;
    grid-template-columns: 36px 36px 1fr auto;
    align-items: start;
    gap: 8px;
    padding: var(--space-xs) var(--space-sm);
    border-bottom: 1px solid rgba(232, 228, 224, 0.3);
    transition: background 0.1s;
  }
  .checklist-row:last-child { border-bottom: none; }
  .checklist-row:hover { background: rgba(232, 228, 224, 0.35); }

  .check-col {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.05rem;
    padding-top: 0.05rem;
    min-width: 44px;
    min-height: 44px;
  }
  .check-box {
    width: 20px;
    height: 20px;
    border: 1.5px solid var(--stroke-moderate);
    border-radius: 3px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.12s;
    flex-shrink: 0;
  }
  .check-box:hover { border-color: var(--accent); }
  .check-box.checked { border-color: transparent; }
  .check-box.set-box.checked { background: var(--status-set); }
  .check-box.test-box.checked { background: var(--status-test); }
  .check-box.checked::after {
    content: '';
    width: 4px;
    height: 7px;
    border: solid var(--white);
    border-width: 0 1.5px 1.5px 0;
    transform: rotate(45deg) translate(-0.5px, -0.5px);
  }
  .check-label {
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    line-height: 1;
  }
  .check-label.lbl-set { color: var(--status-set); }
  .check-label.lbl-test { color: var(--status-test); }

  .item-info {
    padding-top: 0.05rem;
    min-width: 0;
  }
  .item-name {
    font-size: var(--type-base);
    font-weight: 500;
    line-height: 1.25;
  }
  .item-sub {
    font-size: var(--type-xs);
    color: var(--text-muted);
    line-height: 1.3;
  }
  .item-flag {
    font-size: var(--type-xs);
    font-weight: 600;
    color: var(--status-flag);
  }
  .item-qty {
    font-family: var(--font-mono);
    font-size: var(--type-sm);
    color: var(--text-muted);
    padding-top: 0.1rem;
    text-align: right;
    white-space: nowrap;
  }

  .detail-note {
    font-size: var(--type-base); color: var(--text-light);
    margin-top: 0.75rem;
    padding: var(--space-xs) var(--space-sm);
    background: rgba(240, 236, 232, 0.6);
    border-radius: var(--radius-sm);
    line-height: 1.5;
  }

  /* ─── Room Progress Mini Ring ─── */
  .detail-room-ring {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    margin-left: 0.5rem;
  }
  .detail-ring-wrap {
    width: 22px;
    height: 22px;
    position: relative;
  }
  .detail-ring-wrap svg {
    transform: rotate(-90deg);
    width: 22px;
    height: 22px;
  }

  /* ─── Pull Sheet ─── */
  .pull-header { margin-bottom: 0.75rem; }
  .pull-title {
    font-family: var(--font-display);
    font-size: var(--type-md); font-weight: 600;
  }
  .pull-stats {
    font-family: var(--font-mono);
    font-size: var(--type-sm);
    color: var(--text-muted);
    margin-top: 0.1rem;
  }

  .pull-item {
    display: grid;
    grid-template-columns: 24px 24px 1fr auto;
    align-items: center;
    gap: 0.3rem;
    font-size: var(--type-base);
    padding: 0.22rem 0.65rem;
    border-left: 3px solid transparent;
  }
  .pull-check {
    width: 13px;
    height: 13px;
    border-radius: 2px;
    border: 1.5px solid var(--cream);
  }
  .pull-check.set-done { background: var(--status-set); border-color: var(--status-set); }
  .pull-check.test-done { background: var(--status-test); border-color: var(--status-test); }
  .pull-check.partial { background: var(--cream); border-color: var(--stroke-moderate); }

  .pull-item-name { flex: 1; min-width: 0; }
  .pull-item-rooms {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    color: var(--text-muted);
    text-align: right;
    flex-shrink: 0;
  }

  /* ─── Search Results ─── */
  .search-results-header {
    font-family: var(--font-mono);
    font-size: var(--type-sm);
    color: var(--text-muted);
    margin-bottom: 0.5rem;
  }
  .search-result-item {
    padding: 0.45rem 0.65rem;
    border-left: 3px solid var(--cream);
    margin-bottom: 0.3rem;
    cursor: pointer;
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    transition: background 0.15s;
  }
  .search-result-item:hover {
    background: rgba(232, 228, 224, 0.5);
  }
  .search-result-room {
    font-family: var(--font-display);
    font-size: var(--type-base);
    font-weight: 600;
    display: block;
    margin-bottom: 0.1rem;
  }
  .search-result-matches {
    font-size: var(--type-sm);
    color: var(--text-light);
    line-height: 1.4;
  }

  /* ─── Compact Progress (sidebar summary) ─── */
  .compact-progress {
    margin-top: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }
  .compact-bar {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .compact-label {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    font-weight: 500;
    text-transform: uppercase;
    color: var(--text-muted);
    width: 2.5rem;
  }
  .compact-track {
    flex: 1;
    height: 8px;
    background: var(--cream);
    border-radius: 3px;
    overflow: hidden;
  }
  .compact-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .compact-pct {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    color: var(--text-light);
    width: 2rem;
    text-align: right;
  }

  /* ─── Tooltip ─── */
  .svg-tooltip {
    position: fixed;
    background: var(--text);
    color: var(--white);
    font-family: var(--font-body);
    font-size: var(--type-sm);
    padding: 0.3rem 0.65rem;
    border-radius: 6px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 100;
    white-space: nowrap;
    box-shadow: 0 3px 10px var(--shadow-near);
  }
  .svg-tooltip.visible { opacity: 1; }

  /* ─── Print ─── */
  @media print {
    body { padding: 0.5cm; }
    .toolbar { margin-bottom: 0.5cm; }
    .plan-layout { grid-template-columns: 1fr; }
    .plan-card { display: none; }
    .detail-panel {
      position: static;
      max-height: none;
      overflow: visible;
      box-shadow: none;
      page-break-inside: avoid;
    }
    .panel-tabs { display: none; }
    .legend { page-break-inside: avoid; }
    .day-tab { border: 1px solid #ccc; }
    .day-tab.active { background: #666; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .search-box { display: none; }
    .check-box { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .check-box.checked { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .pull-check { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .progress-rings { display: none; }
    .checklist-row:hover { background: transparent; }
  }
  @media print and (not (prefers-reduced-data)) {
    .plan-card { display: block; }
    .plan-layout { grid-template-columns: 1fr var(--sidebar-collapsed); }
  }
</style>
</head>
<body>

<div class="page">

<header>
  <h1 id="venueName">Convene Willis Tower</h1>
  <span class="addr" id="venueAddr"></span>
</header>

<!-- ═══ Toolbar ═══ -->
<div class="toolbar">
  <div class="day-switcher" id="daySwitcher" role="tablist" aria-label="Show day"></div>

  <div class="progress-rings" id="progressRings">
    <div class="ring-group">
      <div class="ring-wrap">
        <svg viewBox="0 0 42 42">
          <circle class="ring-track" cx="21" cy="21" r="17"/>
          <circle class="ring-fill ring-fill-set" cx="21" cy="21" r="17"
                  id="ringSet" stroke-dasharray="106.81" stroke-dashoffset="106.81"/>
        </svg>
        <span class="ring-pct" id="pctSet">0%</span>
      </div>
      <span class="ring-label">Set</span>
    </div>
    <div class="ring-group">
      <div class="ring-wrap">
        <svg viewBox="0 0 42 42">
          <circle class="ring-track" cx="21" cy="21" r="17"/>
          <circle class="ring-fill ring-fill-test" cx="21" cy="21" r="17"
                  id="ringTest" stroke-dasharray="106.81" stroke-dashoffset="106.81"/>
        </svg>
        <span class="ring-pct" id="pctTest">0%</span>
      </div>
      <span class="ring-label">Test</span>
    </div>
    <div class="ring-group">
      <div class="ring-wrap">
        <svg viewBox="0 0 42 42">
          <circle class="ring-track" cx="21" cy="21" r="17"/>
          <circle class="ring-fill ring-fill-ready" cx="21" cy="21" r="17"
                  id="ringReady" stroke-dasharray="106.81" stroke-dashoffset="106.81"/>
        </svg>
        <span class="ring-pct" id="pctReady">0%</span>
      </div>
      <span class="ring-label">Ready</span>
    </div>
  </div>

  <div class="search-box">
    <input type="search" id="searchInput" placeholder="Search gear, rooms, crew..." aria-label="Search equipment">
    <span class="search-count" id="searchCount"></span>
  </div>
</div>

<main class="plan-layout">

<!-- ═══ Floor Plan SVG ═══ -->
<article class="plan-card">
  <svg viewBox="0 0 860 750" xmlns="http://www.w3.org/2000/svg" role="img"
       aria-label="Floor plan of Convene Willis Tower, Floor 3. Click rooms to view equipment details.">
    <defs>
      <filter id="glow-subtle">
        <feGaussianBlur stdDeviation="2" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>

    <!-- Building shell + corridors -->
    <rect class="building-outline" x="3" y="18" width="854" height="710" rx="3"/>
    <rect class="corridor" x="95" y="148" width="520" height="290" rx="1"/>
    <rect class="corridor" x="130" y="80" width="480" height="68"/>
    <rect class="corridor" x="225" y="438" width="350" height="30"/>

    <!-- ═══ ADAMS GALLERY ═══ -->
    <rect class="room" data-room="adams-g" x="5" y="22" width="395" height="52" rx="3"
          tabindex="0" role="button" aria-label="Adams Gallery"/>
    <text class="label-room sm" x="203" y="52">ADAMS GALLERY</text>

    <!-- ═══ FORUM ═══ -->
    <rect class="room" data-room="forum" x="625" y="22" width="195" height="88" rx="3"
          tabindex="0" role="button" aria-label="Forum Combined"/>
    <text class="label-room" x="722" y="56">FORUM</text>
    <text class="label-room sm" x="722" y="72">COMBINED</text>
    <text class="label-count" data-count-for="forum" x="722" y="88"></text>
    <line class="divider-line" x1="625" y1="112" x2="820" y2="112"/>

    <!-- ═══ FORUM SOUTH ═══ -->
    <rect class="room" data-room="forum-s" x="625" y="113" width="195" height="80" rx="3"
          tabindex="0" role="button" aria-label="Forum South"/>
    <text class="label-room sm" x="722" y="157">FORUM SOUTH</text>

    <!-- ═══ ADAMS STUDIO ═══ -->
    <rect class="room" data-room="adams-st" x="5" y="79" width="108" height="55" rx="3"
          tabindex="0" role="button" aria-label="Adams Studio"/>
    <text class="label-room sm" x="59" y="104">ADAMS STUDIO</text>
    <text class="label-count" data-count-for="adams-st" x="59" y="121"></text>

    <!-- ═══ BOARDROOMS ═══ -->
    <rect class="room" data-room="khan" x="125" y="82" width="78" height="48" rx="3"
          tabindex="0" role="button" aria-label="Khan Boardroom"/>
    <text class="label-room xs" x="164" y="110">KHAN</text>

    <rect class="room" data-room="olmstead" x="210" y="82" width="78" height="48" rx="3"
          tabindex="0" role="button" aria-label="Olmstead Boardroom"/>
    <text class="label-room xs" x="249" y="110">OLMSTEAD</text>

    <rect class="room" data-room="farrand" x="5" y="148" width="120" height="48" rx="3"
          tabindex="0" role="button" aria-label="Farrand Boardroom"/>
    <text class="label-room xs" x="65" y="176">FARRAND</text>

    <rect class="room" data-room="miller" x="5" y="208" width="70" height="42" rx="3"
          tabindex="0" role="button" aria-label="Miller Boardroom"/>
    <text class="label-room xs" x="40" y="233">MILLER</text>

    <!-- ═══ WACKER STUDIO ═══ -->
    <rect class="room" data-room="wacker-st" x="5" y="262" width="85" height="100" rx="3"
          tabindex="0" role="button" aria-label="Wacker Studio"/>
    <text class="label-room sm" x="48" y="305">WACKER</text>
    <text class="label-sub" x="48" y="320">STUDIO</text>
    <text class="label-count" data-count-for="wacker-st" x="48" y="337"></text>

    <!-- ═══ WACKER GALLERY ═══ -->
    <rect class="room" data-room="wacker-g" x="5" y="374" width="52" height="155" rx="3"
          tabindex="0" role="button" aria-label="Wacker Gallery"/>
    <text class="label-room xs" x="31" y="452" transform="rotate(-90 31 452)">WACKER GALLERY</text>

    <!-- ═══ FRANKLIN GALLERY ═══ -->
    <rect class="room" data-room="franklin-g" x="625" y="200" width="195" height="228" rx="3"
          tabindex="0" role="button" aria-label="Franklin Gallery"/>
    <text class="label-room sm" x="722" y="308">FRANKLIN</text>
    <text class="label-sub" x="722" y="326">GALLERY</text>

    <!-- ═══ SERVICE ═══ -->
    <rect class="room" data-room="elev" x="265" y="335" width="108" height="48" rx="3"
          tabindex="0" role="button" aria-label="Elevator Bank Hallway"/>
    <text class="label-room xs" x="319" y="363">ELEVATORS</text>

    <rect class="room" data-room="green" x="625" y="432" width="60" height="45" rx="3"
          tabindex="0" role="button" aria-label="Green Room"/>
    <text class="label-room xs" x="655" y="458">GREEN RM</text>

    <!-- Entrance marker -->
    <polygon class="entrance-marker" points="185,343 191,353 179,353"/>
    <text class="entrance-label" x="185" y="365">ENTRANCE</text>

    <!-- ═══ HALL ═══ -->
    <rect class="room" data-room="hall" x="580" y="482" width="235" height="135" rx="3"
          tabindex="0" role="button" aria-label="Hall Combined"/>
    <text class="label-room" x="698" y="538">HALL</text>
    <text class="label-room sm" x="698" y="554">COMBINED</text>
    <text class="label-count" data-count-for="hall" x="698" y="570"></text>
    <line class="divider-line" x1="580" y1="619" x2="815" y2="619"/>

    <!-- ═══ HALL SOUTH ═══ -->
    <rect class="room" data-room="hall-s" x="580" y="621" width="235" height="90" rx="3"
          tabindex="0" role="button" aria-label="Hall South"/>
    <text class="label-room" x="698" y="662">HALL SOUTH</text>
    <text class="label-count" data-count-for="hall-s" x="698" y="679"></text>

    <!-- ═══ HUB ═══ -->
    <rect class="room" data-room="hub" x="5" y="535" width="215" height="118" rx="3"
          tabindex="0" role="button" aria-label="Hub"/>
    <text class="label-room" x="113" y="590">HUB</text>
    <text class="label-count" data-count-for="hub" x="113" y="608"></text>

    <!-- ═══ JACKSON GALLERY ═══ -->
    <rect class="room" data-room="jackson-g" x="225" y="558" width="340" height="92" rx="3"
          tabindex="0" role="button" aria-label="Jackson Gallery"/>
    <text class="label-room sm" x="395" y="608">JACKSON GALLERY</text>

    <!-- Terraces (decorative) -->
    <rect x="3" y="732" width="120" height="14" rx="2" fill="none" stroke="var(--cream)" stroke-width="0.4" stroke-dasharray="3 2"/>
    <rect x="340" y="732" width="130" height="14" rx="2" fill="none" stroke="var(--cream)" stroke-width="0.4" stroke-dasharray="3 2"/>
    <rect x="620" y="732" width="200" height="14" rx="2" fill="none" stroke="var(--cream)" stroke-width="0.4" stroke-dasharray="3 2"/>
  </svg>

  <nav class="legend" aria-label="Gear density legend">
    <span class="legend-title" id="legendTitle">Gear Load</span>
    <div class="legend-step"><div class="legend-swatch sw-0"></div><span class="legend-label" data-lbl="0">Empty</span></div>
    <span class="legend-sep">&rsaquo;</span>
    <div class="legend-step"><div class="legend-swatch sw-1"></div><span class="legend-label" data-lbl="1">Light</span></div>
    <span class="legend-sep">&rsaquo;</span>
    <div class="legend-step"><div class="legend-swatch sw-2"></div><span class="legend-label" data-lbl="2">Moderate</span></div>
    <span class="legend-sep">&rsaquo;</span>
    <div class="legend-step"><div class="legend-swatch sw-3"></div><span class="legend-label" data-lbl="3">Heavy</span></div>
    <span class="legend-sep">&rsaquo;</span>
    <div class="legend-step"><div class="legend-swatch sw-4"></div><span class="legend-label" data-lbl="4">Dense</span></div>

    <div class="legend-modes">
      <button class="legend-mode-btn active" data-mode="gear">Gear</button>
      <button class="legend-mode-btn" data-mode="setup">Setup</button>
      <button class="legend-mode-btn" data-mode="test">Test</button>
    </div>
  </nav>
</article>

<!-- ═══ Detail Panel ═══ -->
<aside class="detail-panel" id="detailPanel" role="complementary" aria-label="Room equipment details">
  <div class="panel-tabs">
    <button class="panel-tab active" data-view="room">Room</button>
    <button class="panel-tab" data-view="pull">Pull Sheet</button>
  </div>

  <div id="roomView">
    <div class="detail-empty" id="detailEmpty">
      Click a room to see equipment
      <span class="hint">Or press Tab to navigate, Enter to select</span>
    </div>
    <div id="detailContent" style="display:none" aria-live="polite"></div>
  </div>

  <div id="searchResultsView" style="display:none">
    <div id="searchResults" aria-live="polite"></div>
  </div>

  <div id="pullView" style="display:none">
    <div id="pullContent"></div>
  </div>
</aside>

</main>
</div>

<!-- Tooltip element -->
<div class="svg-tooltip" id="tooltip"></div>

<script src="data/g2-conference.js"></script>
<script>
'use strict';

// ══════════════════════════════════════════════════════════════════════════════
// StateManager — localStorage wrapper for checklist state
// ══════════════════════════════════════════════════════════════════════════════
const StateManager = {
  _getKey(roomId) {
    return `convene_floor_${roomId}`;
  },
  _itemKey(roomId, itemName, day) {
    return `${roomId}__${day}__${itemName.replace(/\s+/g, '_')}`;
  },

  get(roomId) {
    const key = this._getKey(roomId);
    const val = localStorage.getItem(key);
    return val ? JSON.parse(val) : {};
  },

  set(roomId, stateObj) {
    const key = this._getKey(roomId);
    localStorage.setItem(key, JSON.stringify(stateObj));
  },

  getItemState(roomId, itemName, day) {
    const state = this.get(roomId);
    const ik = this._itemKey(roomId, itemName, day);
    return state[ik] || { set: false, test: false };
  },

  setItemState(roomId, itemName, day, stateObj) {
    const state = this.get(roomId);
    const ik = this._itemKey(roomId, itemName, day);
    state[ik] = stateObj;
    this.set(roomId, state);
  },

  clear(roomId) {
    const key = this._getKey(roomId);
    localStorage.removeItem(key);
  },

  clearAll() {
    Object.keys(localStorage).forEach(k => {
      if (k.startsWith('convene_floor_')) localStorage.removeItem(k);
    });
  }
};

// ══════════════════════════════════════════════════════════════════════════════
// Config
// ══════════════════════════════════════════════════════════════════════════════
const FULL_VIEWBOX = { x: 0, y: 0, w: 860, h: 750 };
const ROOM_LABELS = {
  'adams-g': 'Adams Gallery',
  'forum': 'Forum Combined',
  'forum-s': 'Forum South',
  'adams-st': 'Adams Studio',
  'khan': 'Khan',
  'olmstead': 'Olmstead',
  'farrand': 'Farrand',
  'miller': 'Miller',
  'wacker-st': 'Wacker Studio',
  'wacker-g': 'Wacker Gallery',
  'franklin-g': 'Franklin Gallery',
  'elev': 'Elevators',
  'green': 'Green Room',
  'hall': 'Hall Combined',
  'hall-s': 'Hall South',
  'hub': 'Hub',
  'jackson-g': 'Jackson Gallery'
};
const ROOM_TYPES = {
  'adams-g': 'gallery',
  'forum': 'meeting',
  'forum-s': 'meeting',
  'adams-st': 'studio',
  'khan': 'meeting',
  'olmstead': 'meeting',
  'farrand': 'meeting',
  'miller': 'meeting',
  'wacker-st': 'studio',
  'wacker-g': 'gallery',
  'franklin-g': 'gallery',
  'elev': 'service',
  'green': 'service',
  'hall': 'meeting',
  'hall-s': 'meeting',
  'hub': 'meeting',
  'jackson-g': 'gallery'
};
const RING_CIRC = 2 * Math.PI * 17; // Updated for r=17

// ══════════════════════════════════════════════════════════════════════════════
// State
// ══════════════════════════════════════════════════════════════════════════════
let currentDay = 'all';
let selectedRoom = null;
let currentIntensityMode = 'gear';
let currentView = 'room'; // room, pull, search
let searchResults = [];

const planSvg = document.querySelector('.plan-card svg');
const planLayout = document.querySelector('.plan-layout');
const detailPanel = document.getElementById('detailPanel');
const detailContent = document.getElementById('detailContent');
const detailEmpty = document.getElementById('detailEmpty');

// ══════════════════════════════════════════════════════════════════════════════
// Data Layer
// ══════════════════════════════════════════════════════════════════════════════
function getRoomDay(roomId, day) {
  const data = EVENT_DATA.rooms[roomId];
  if (!data) return null;
  if (day === 'all') return data;
  return data.days && data.days[day] ? { ...data, ...data.days[day] } : null;
}

function flattenItems(roomData) {
  if (!roomData || !roomData.categories) return [];
  const out = [];
  Object.keys(roomData.categories).forEach(catKey => {
    const cat = roomData.categories[catKey];
    (cat.items || []).forEach(it => {
      out.push({ ...it, category: catKey, categoryLabel: cat.label });
    });
  });
  return out;
}

function countItems(roomData) {
  const items = flattenItems(roomData);
  let total = 0;
  items.forEach(it => {
    const q = it.qty || 1;
    total += q;
  });
  return { count: items.length, total };
}

function getIntensity(roomData) {
  if (!roomData) return 0;
  const { total } = countItems(roomData);
  if (total === 0) return 0;
  if (total <= 5) return 1;
  if (total <= 12) return 2;
  if (total <= 25) return 3;
  return 4;
}

function getProgressIntensity(pct) {
  if (pct === 0) return 0;
  if (pct <= 25) return 1;
  if (pct <= 50) return 2;
  if (pct <= 75) return 3;
  return 4;
}

// ══════════════════════════════════════════════════════════════════════════════
// Day Switcher
// ══════════════════════════════════════════════════════════════════════════════
function renderDayTabs() {
  const sw = document.getElementById('daySwitcher');
  if (!EVENT_DATA.days) return;

  const allBtn = document.createElement('button');
  allBtn.className = 'day-tab active';
  allBtn.dataset.day = 'all';
  allBtn.innerHTML = 'All Days';
  allBtn.setAttribute('role', 'tab');
  allBtn.setAttribute('aria-selected', 'true');
  allBtn.onclick = () => setDay('all');
  sw.appendChild(allBtn);

  EVENT_DATA.days.forEach(d => {
    const btn = document.createElement('button');
    btn.className = 'day-tab';
    btn.dataset.day = d.id;
    btn.innerHTML = `${d.name}<span class="day-label">${d.date}</span>`;
    btn.setAttribute('role', 'tab');
    btn.setAttribute('aria-selected', 'false');
    btn.onclick = () => setDay(d.id);
    sw.appendChild(btn);
  });
}

function setDay(d) {
  if (currentDay === d) return;
  currentDay = d;

  document.querySelectorAll('.day-tab').forEach(btn => {
    const active = btn.dataset.day === d;
    btn.classList.toggle('active', active);
    btn.setAttribute('aria-selected', active);
  });

  updateRoomStates();
  updateProgressRings();

  if (selectedRoom) {
    renderRoomDetailCompact(selectedRoom);
  }
}

// ══════════════════════════════════════════════════════════════════════════════
// Intensity Mode (Gear / Setup / Test)
// ══════════════════════════════════════════════════════════════════════════════
function setIntensityMode(mode) {
  currentIntensityMode = mode;
  document.querySelectorAll('.legend-mode-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });

  const title = document.getElementById('legendTitle');
  if (mode === 'gear') title.textContent = 'Gear Load';
  else if (mode === 'setup') title.textContent = 'Setup Progress';
  else title.textContent = 'Test Progress';

  updateRoomStates();
}

document.querySelectorAll('.legend-mode-btn').forEach(btn => {
  btn.onclick = () => setIntensityMode(btn.dataset.mode);
});

// ══════════════════════════════════════════════════════════════════════════════
// Room States (fill/stroke based on mode)
// ══════════════════════════════════════════════════════════════════════════════
function updateRoomStates() {
  document.querySelectorAll('.room').forEach(el => {
    const rid = el.dataset.room;
    const data = getRoomDay(rid, currentDay);

    if (!data) {
      el.classList.remove('i0', 'i1', 'i2', 'i3', 'i4');
      el.classList.add('i0');
      return;
    }

    let intensity = 0;
    if (currentIntensityMode === 'gear') {
      intensity = getIntensity(data);
    } else {
      const items = flattenItems(data);
      if (items.length === 0) {
        intensity = 0;
      } else {
        let done = 0;
        items.forEach(it => {
          const s = StateManager.getItemState(rid, it.name, currentDay);
          if (currentIntensityMode === 'setup' && s.set) done++;
          if (currentIntensityMode === 'test' && s.test) done++;
        });
        const pct = Math.round((done / items.length) * 100);
        intensity = getProgressIntensity(pct);
      }
    }

    el.classList.remove('i0', 'i1', 'i2', 'i3', 'i4');
    el.classList.add('i' + intensity);
  });

  updateItemCounts();
  updateAllStatusBars();
}

// ══════════════════════════════════════════════════════════════════════════════
// Item Counts (in SVG)
// ══════════════════════════════════════════════════════════════════════════════
function updateItemCounts() {
  document.querySelectorAll('[data-count-for]').forEach(el => {
    const rid = el.dataset.countFor;
    const data = getRoomDay(rid, currentDay);
    if (!data) {
      el.textContent = '';
      return;
    }
    const { count } = countItems(data);
    el.textContent = count > 0 ? `${count} items` : '';
  });
}

// ══════════════════════════════════════════════════════════════════════════════
// SVG Status Bars (per-room mini progress bars)
// ══════════════════════════════════════════════════════════════════════════════
function createRoomStatusBars() {
  const svg = document.querySelector('.plan-card svg');
  if (svg.querySelector('#statusBars')) return;

  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.id = 'statusBars';

  document.querySelectorAll('.room').forEach(el => {
    const bbox = el.getBBox();
    const rid = el.dataset.room;
    const x = bbox.x + 2;
    const y = bbox.y + bbox.height - 5;
    const w = bbox.width - 4;
    const h = 2;

    const roomG = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    roomG.dataset.room = rid;

    const track = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    track.classList.add('status-track-rect');
    track.setAttribute('x', x);
    track.setAttribute('y', y);
    track.setAttribute('width', w);
    track.setAttribute('height', h);
    track.setAttribute('rx', 0.5);
    roomG.appendChild(track);

    const setBar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    setBar.classList.add('status-set-rect');
    setBar.dataset.barType = 'set';
    setBar.setAttribute('x', x);
    setBar.setAttribute('y', y);
    setBar.setAttribute('width', 0);
    setBar.setAttribute('height', h);
    setBar.setAttribute('rx', 0.5);
    roomG.appendChild(setBar);

    const testBar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    testBar.classList.add('status-test-rect');
    testBar.dataset.barType = 'test';
    testBar.setAttribute('x', x);
    testBar.setAttribute('y', y);
    testBar.setAttribute('width', 0);
    testBar.setAttribute('height', h);
    testBar.setAttribute('rx', 0.5);
    roomG.appendChild(testBar);

    g.appendChild(roomG);
  });

  svg.appendChild(g);
}

function updateAllStatusBars() {
  document.querySelectorAll('#statusBars g').forEach(g => {
    const rid = g.dataset.room;
    updateRoomStatusBars(rid);
  });
}

function updateRoomStatusBars(roomId) {
  const g = document.querySelector(`#statusBars g[data-room="${roomId}"]`);
  if (!g) return;

  const data = getRoomDay(roomId, currentDay);
  if (!data) {
    g.style.opacity = '0';
    return;
  }

  const items = flattenItems(data);
  if (items.length === 0) {
    g.style.opacity = '0';
    return;
  }

  g.style.opacity = '1';

  let setDone = 0, testDone = 0;
  items.forEach(it => {
    const s = StateManager.getItemState(roomId, it.name, currentDay);
    if (s.set) setDone++;
    if (s.test) testDone++;
  });

  const setPct = (setDone / items.length) * 100;
  const testPct = (testDone / items.length) * 100;

  const track = g.querySelector('.status-track-rect');
  const trackW = parseFloat(track.getAttribute('width'));
  const trackX = parseFloat(track.getAttribute('x'));

  const setBar = g.querySelector('[data-bar-type="set"]');
  const testBar = g.querySelector('[data-bar-type="test"]');

  const setW = (setPct / 100) * trackW;
  const testW = (testPct / 100) * trackW;

  setBar.setAttribute('width', setW);
  testBar.setAttribute('x', trackX + setW);
  testBar.setAttribute('width', testW);
}

// ══════════════════════════════════════════════════════════════════════════════
// ViewBox Panning (no zoom, pan only)
// ══════════════════════════════════════════════════════════════════════════════
function animateViewBox(target, duration) {
  const current = {
    x: parseFloat(planSvg.getAttribute('viewBox').split(' ')[0]) || 0,
    y: parseFloat(planSvg.getAttribute('viewBox').split(' ')[1]) || 0,
    w: parseFloat(planSvg.getAttribute('viewBox').split(' ')[2]) || FULL_VIEWBOX.w,
    h: parseFloat(planSvg.getAttribute('viewBox').split(' ')[3]) || FULL_VIEWBOX.h
  };

  const start = performance.now();

  function step(now) {
    const elapsed = now - start;
    const t = Math.min(elapsed / duration, 1);
    const ease = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;

    const x = current.x + (target.x - current.x) * ease;
    const y = current.y + (target.y - current.y) * ease;
    const w = current.w + (target.w - current.w) * ease;
    const h = current.h + (target.h - current.h) * ease;

    planSvg.setAttribute('viewBox', `${x} ${y} ${w} ${h}`);

    if (t < 1) requestAnimationFrame(step);
  }

  requestAnimationFrame(step);
}

function zoomOut() {
  animateViewBox(FULL_VIEWBOX, 400);
}

function zoomToRoom(el) {
  const bbox = el.getBBox();
  const cx = bbox.x + bbox.width / 2;
  const cy = bbox.y + bbox.height / 2;

  const pad = 60;
  const aspect = FULL_VIEWBOX.w / FULL_VIEWBOX.h;

  let targetW = bbox.width + pad * 2;
  let targetH = bbox.height + pad * 2;

  if (targetW / targetH > aspect) {
    targetH = targetW / aspect;
  } else {
    targetW = targetH * aspect;
  }

  targetW = Math.min(targetW, FULL_VIEWBOX.w);
  targetH = Math.min(targetH, FULL_VIEWBOX.h);

  let targetX = cx - targetW / 2;
  let targetY = cy - targetH / 2;

  if (targetX < 0) targetX = 0;
  if (targetY < 0) targetY = 0;
  if (targetX + targetW > FULL_VIEWBOX.w) targetX = FULL_VIEWBOX.w - targetW;
  if (targetY + targetH > FULL_VIEWBOX.h) targetY = FULL_VIEWBOX.h - targetH;

  animateViewBox({ x: targetX, y: targetY, w: targetW, h: targetH }, 500);
}

// ══════════════════════════════════════════════════════════════════════════════
// Room Overlay (modal detail view)
// ══════════════════════════════════════════════════════════════════════════════
let roomOverlay = null;

function showRoomOverlay(roomId) {
  if (!roomOverlay) {
    roomOverlay = document.createElement('div');
    roomOverlay.className = 'room-overlay';
    document.querySelector('.plan-card').appendChild(roomOverlay);
  }

  const data = getRoomDay(roomId, currentDay);
  if (!data) {
    roomOverlay.innerHTML = '<p>No data for this room</p>';
    return;
  }

  const html = renderRoomDetail(roomId, data);
  roomOverlay.innerHTML = html;

  requestAnimationFrame(() => {
    roomOverlay.classList.add('visible');
  });

  const closeBtn = roomOverlay.querySelector('.overlay-close');
  if (closeBtn) {
    closeBtn.onclick = () => hideRoomOverlay();
  }

  bindCheckboxes(roomId);
}

function hideRoomOverlay(immediate = false) {
  if (!roomOverlay) return;
  if (immediate) {
    roomOverlay.classList.remove('visible');
    setTimeout(() => {
      if (roomOverlay && roomOverlay.parentNode) {
        roomOverlay.parentNode.removeChild(roomOverlay);
        roomOverlay = null;
      }
    }, 350);
  } else {
    roomOverlay.classList.remove('visible');
    setTimeout(() => {
      if (roomOverlay && roomOverlay.parentNode) {
        roomOverlay.parentNode.removeChild(roomOverlay);
        roomOverlay = null;
      }
    }, 350);
  }
}

// ══════════════════════════════════════════════════════════════════════════════
// Room Detail Render (compact for sidebar)
// ══════════════════════════════════════════════════════════════════════════════
function renderRoomDetailCompact(roomId) {
  const data = getRoomDay(roomId, currentDay);
  if (!data) {
    detailContent.style.display = 'none';
    detailEmpty.style.display = 'block';
    return;
  }

  detailEmpty.style.display = 'none';
  detailContent.style.display = 'block';

  const name = ROOM_LABELS[roomId] || roomId;
  const type = ROOM_TYPES[roomId] || 'meeting';
  const { count } = countItems(data);

  const items = flattenItems(data);
  let setDone = 0, testDone = 0;
  items.forEach(it => {
    const s = StateManager.getItemState(roomId, it.name, currentDay);
    if (s.set) setDone++;
    if (s.test) testDone++;
  });
  const setPct = items.length > 0 ? Math.round((setDone / items.length) * 100) : 0;
  const testPct = items.length > 0 ? Math.round((testDone / items.length) * 100) : 0;

  let html = `
    <div class="detail-header">${name}</div>
    <div class="detail-meta">
      <span class="detail-type dt-${type}">${type}</span>
      <span class="detail-count">${count} items</span>
    </div>
  `;

  if (data.tags && data.tags.length > 0) {
    html += '<div class="detail-tags">';
    data.tags.forEach(t => {
      const cls = t.toLowerCase().replace(/\s+/g, '-');
      html += `<span class="detail-tag tag-${cls}">${t}</span>`;
    });
    html += '</div>';
  }

  if (data.crew) {
    html += `<div class="detail-crew">Crew: ${data.crew}</div>`;
  }

  html += `
    <div class="compact-progress">
      <div class="compact-bar">
        <span class="compact-label">Set</span>
        <div class="compact-track">
          <div class="compact-fill" style="width: ${setPct}%; background: var(--status-set);"></div>
        </div>
        <span class="compact-pct">${setPct}%</span>
      </div>
      <div class="compact-bar">
        <span class="compact-label">Test</span>
        <div class="compact-track">
          <div class="compact-fill" style="width: ${testPct}%; background: var(--status-test);"></div>
        </div>
        <span class="compact-pct">${testPct}%</span>
      </div>
    </div>
  `;

  if (data.notes) {
    html += `<div class="detail-note">${data.notes}</div>`;
  }

  detailContent.innerHTML = html;
  detailContent.classList.add('revealing');
  setTimeout(() => detailContent.classList.remove('revealing'), 500);
}

// ══════════════════════════════════════════════════════════════════════════════
// Room Detail Render (full checklist for overlay)
// ══════════════════════════════════════════════════════════════════════════════
function renderRoomDetail(roomId, data) {
  const name = ROOM_LABELS[roomId] || roomId;
  const type = ROOM_TYPES[roomId] || 'meeting';
  const { count } = countItems(data);

  let html = `
    <button class="overlay-close" aria-label="Close">&times;</button>
    <div class="detail-header">${name}</div>
    <div class="detail-meta">
      <span class="detail-type dt-${type}">${type}</span>
      <span class="detail-count">${count} items</span>
    </div>
  `;

  if (data.tags && data.tags.length > 0) {
    html += '<div class="detail-tags">';
    data.tags.forEach(t => {
      const cls = t.toLowerCase().replace(/\s+/g, '-');
      html += `<span class="detail-tag tag-${cls}">${t}</span>`;
    });
    html += '</div>';
  }

  if (data.crew) {
    html += `<div class="detail-crew">Crew: ${data.crew}</div>`;
  }

  if (data.categories) {
    Object.keys(data.categories).forEach(catKey => {
      const cat = data.categories[catKey];
      const catClass = catKey.replace(/_/g, '-');
      html += `<div class="detail-section-label cat-${catClass}">${cat.label}</div>`;

      (cat.items || []).forEach(it => {
        const state = StateManager.getItemState(roomId, it.name, currentDay);
        const setClass = state.set ? 'checked' : '';
        const testClass = state.test ? 'checked' : '';

        html += `
          <div class="checklist-row">
            <div class="check-col">
              <div class="check-box set-box ${setClass}" data-item="${it.name}" data-type="set"></div>
              <span class="check-label lbl-set">Set</span>
            </div>
            <div class="check-col">
              <div class="check-box test-box ${testClass}" data-item="${it.name}" data-type="test"></div>
              <span class="check-label lbl-test">Test</span>
            </div>
            <div class="item-info">
              <div class="item-name">${it.name}</div>
              ${it.model ? `<div class="item-sub">${it.model}</div>` : ''}
              ${it.flag ? `<div class="item-flag">${it.flag}</div>` : ''}
            </div>
            ${it.qty && it.qty > 1 ? `<div class="item-qty">&times;${it.qty}</div>` : '<div></div>'}
          </div>
        `;
      });
    });
  }

  if (data.notes) {
    html += `<div class="detail-note">${data.notes}</div>`;
  }

  return html;
}

// ══════════════════════════════════════════════════════════════════════════════
// Checkbox Binding
// ══════════════════════════════════════════════════════════════════════════════
function bindCheckboxes(roomId) {
  const container = roomOverlay || detailContent;
  container.querySelectorAll('.check-box').forEach(box => {
    box.onclick = (e) => {
      e.stopPropagation();
      const itemName = box.dataset.item;
      const type = box.dataset.type;
      const state = StateManager.getItemState(roomId, itemName, currentDay);

      if (type === 'set') state.set = !state.set;
      if (type === 'test') state.test = !state.test;

      StateManager.setItemState(roomId, itemName, currentDay, state);

      box.classList.toggle('checked');
      box.classList.add('popping');
      setTimeout(() => box.classList.remove('popping'), 300);

      updateRoomStates();
      updateProgressRings();
      updateRoomStatusBars(roomId);

      if (currentIntensityMode === 'setup' || currentIntensityMode === 'test') {
        updateRoomStates();
      }
    };
  });
}

// ══════════════════════════════════════════════════════════════════════════════
// Progress Rings
// ══════════════════════════════════════════════════════════════════════════════
function updateProgressRings() {
  let totalItems = 0;
  let setDone = 0;
  let testDone = 0;
  let readyDone = 0;

  Object.keys(EVENT_DATA.rooms).forEach(rid => {
    const data = getRoomDay(rid, currentDay);
    if (!data) return;
    const items = flattenItems(data);
    totalItems += items.length;

    items.forEach(it => {
      const s = StateManager.getItemState(rid, it.name, currentDay);
      if (s.set) setDone++;
      if (s.test) testDone++;
      if (s.set && s.test) readyDone++;
    });
  });

  const setPct = totalItems > 0 ? Math.round((setDone / totalItems) * 100) : 0;
  const testPct = totalItems > 0 ? Math.round((testDone / totalItems) * 100) : 0;
  const readyPct = totalItems > 0 ? Math.round((readyDone / totalItems) * 100) : 0;

  updateRing('ringSet', 'pctSet', setPct);
  updateRing('ringTest', 'pctTest', testPct);
  updateRing('ringReady', 'pctReady', readyPct);
}

function updateRing(ringId, pctId, pct) {
  const ring = document.getElementById(ringId);
  const pctEl = document.getElementById(pctId);
  const offset = RING_CIRC - (pct / 100) * RING_CIRC;
  ring.style.strokeDashoffset = offset;
  pctEl.textContent = `${pct}%`;
}

// ══════════════════════════════════════════════════════════════════════════════
// Room Selection
// ══════════════════════════════════════════════════════════════════════════════
function selectRoom(el) {
  clearSelection(true);

  selectedRoom = el.dataset.room;
  el.classList.add('selected', 'selecting');
  el.setAttribute('aria-selected', 'true');

  setTimeout(() => el.classList.remove('selecting'), 500);

  zoomToRoom(el);
  renderRoomDetailCompact(selectedRoom);

  setTimeout(() => {
    showRoomOverlay(selectedRoom);
  }, 350);

  updateHash();
}

function clearSelection(silent = false) {
  if (!selectedRoom) return;

  const el = document.querySelector(`.room[data-room="${selectedRoom}"]`);
  if (el) {
    el.classList.remove('selected');
    el.classList.add('deselecting');
    el.setAttribute('aria-selected', 'false');
    setTimeout(() => el.classList.remove('deselecting'), 350);
  }

  selectedRoom = null;
  hideRoomOverlay();

  if (!silent) {
    detailContent.style.display = 'none';
    detailEmpty.style.display = 'block';
    zoomOut();
    updateHash();
  }
}

document.querySelectorAll('.room').forEach(el => {
  el.onclick = () => selectRoom(el);
  el.onkeydown = (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      selectRoom(el);
    }
  };
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') clearSelection();
});

// ══════════════════════════════════════════════════════════════════════════════
// Search
// ══════════════════════════════════════════════════════════════════════════════
function searchGear(query) {
  const q = query.toLowerCase().trim();
  if (!q) return [];

  const results = [];
  Object.keys(EVENT_DATA.rooms).forEach(rid => {
    const data = getRoomDay(rid, currentDay);
    if (!data) return;
    const items = flattenItems(data);
    const matches = items.filter(it => {
      return it.name.toLowerCase().includes(q) ||
             (it.model && it.model.toLowerCase().includes(q)) ||
             (it.flag && it.flag.toLowerCase().includes(q));
    });
    if (matches.length > 0) {
      results.push({ roomId: rid, matches });
    }
  });
  return results;
}

function handleSearch() {
  const input = document.getElementById('searchInput');
  const query = input.value;
  const countEl = document.getElementById('searchCount');

  if (!query) {
    countEl.classList.remove('visible');
    document.querySelectorAll('.room').forEach(r => {
      r.classList.remove('search-dim', 'search-match');
    });
    searchResults = [];
    switchPanel('room');
    return;
  }

  searchResults = searchGear(query);
  const total = searchResults.reduce((sum, r) => sum + r.matches.length, 0);

  countEl.textContent = `${total} found`;
  countEl.classList.add('visible');

  const matchedRooms = new Set(searchResults.map(r => r.roomId));
  document.querySelectorAll('.room').forEach(r => {
    const rid = r.dataset.room;
    if (matchedRooms.has(rid)) {
      r.classList.remove('search-dim');
      r.classList.add('search-match');
    } else {
      r.classList.add('search-dim');
      r.classList.remove('search-match');
    }
  });

  renderSearchResults();
  switchPanel('search');
}

document.getElementById('searchInput').oninput = handleSearch;

function renderSearchResults() {
  const container = document.getElementById('searchResults');
  if (searchResults.length === 0) {
    container.innerHTML = '<div class="detail-empty">No matches found</div>';
    return;
  }

  let html = `<div class="search-results-header">${searchResults.length} rooms with matches</div>`;
  searchResults.forEach(r => {
    const name = ROOM_LABELS[r.roomId] || r.roomId;
    const matchStr = r.matches.map(m => m.name).join(', ');
    html += `
      <div class="search-result-item" data-room="${r.roomId}">
        <span class="search-result-room">${name}</span>
        <div class="search-result-matches">${matchStr}</div>
      </div>
    `;
  });
  container.innerHTML = html;

  container.querySelectorAll('.search-result-item').forEach(item => {
    item.onclick = () => {
      const rid = item.dataset.room;
      const el = document.querySelector(`.room[data-room="${rid}"]`);
      if (el) selectRoom(el);
    };
  });
}

// ══════════════════════════════════════════════════════════════════════════════
// Panel Tabs (Room / Pull Sheet)
// ══════════════════════════════════════════════════════════════════════════════
function switchPanel(view) {
  currentView = view;
  document.querySelectorAll('.panel-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.view === view);
  });

  document.getElementById('roomView').style.display = view === 'room' ? 'block' : 'none';
  document.getElementById('pullView').style.display = view === 'pull' ? 'block' : 'none';
  document.getElementById('searchResultsView').style.display = view === 'search' ? 'block' : 'none';

  if (view === 'pull') renderPullSheet();
}

document.querySelectorAll('.panel-tab').forEach(tab => {
  tab.onclick = () => switchPanel(tab.dataset.view);
});

// ══════════════════════════════════════════════════════════════════════════════
// Pull Sheet
// ══════════════════════════════════════════════════════════════════════════════
function renderPullSheet() {
  const container = document.getElementById('pullContent');

  const allItems = {};
  Object.keys(EVENT_DATA.rooms).forEach(rid => {
    const data = getRoomDay(rid, currentDay);
    if (!data) return;
    flattenItems(data).forEach(it => {
      const key = it.name + (it.model || '');
      if (!allItems[key]) {
        allItems[key] = { ...it, rooms: [] };
      }
      allItems[key].rooms.push(rid);
    });
  });

  const sorted = Object.values(allItems).sort((a, b) => a.name.localeCompare(b.name));

  let html = `
    <div class="pull-header">
      <div class="pull-title">Pull Sheet</div>
      <div class="pull-stats">${sorted.length} unique items</div>
    </div>
  `;

  sorted.forEach(it => {
    let setAll = true, testAll = true;
    it.rooms.forEach(rid => {
      const s = StateManager.getItemState(rid, it.name, currentDay);
      if (!s.set) setAll = false;
      if (!s.test) testAll = false;
    });

    const setClass = setAll ? 'set-done' : 'partial';
    const testClass = testAll ? 'test-done' : 'partial';

    const roomNames = it.rooms.map(rid => ROOM_LABELS[rid] || rid).join(', ');

    html += `
      <div class="pull-item">
        <div class="pull-check ${setClass}"></div>
        <div class="pull-check ${testClass}"></div>
        <div class="pull-item-name">${it.name}</div>
        <div class="pull-item-rooms">${roomNames}</div>
      </div>
    `;
  });

  container.innerHTML = html;
}

// ══════════════════════════════════════════════════════════════════════════════
// Tooltip
// ══════════════════════════════════════════════════════════════════════════════
const tooltip = document.getElementById('tooltip');

function showTooltip(el, text) {
  tooltip.textContent = text;
  tooltip.classList.add('visible');
  positionTooltip(el);
}

function positionTooltip(el) {
  const rect = el.getBoundingClientRect();
  tooltip.style.left = `${rect.left + rect.width / 2}px`;
  tooltip.style.top = `${rect.top - 8}px`;
  tooltip.style.transform = 'translate(-50%, -100%)';
}

function hideTooltip() {
  tooltip.classList.remove('visible');
}

document.querySelectorAll('.room').forEach(el => {
  el.onmouseenter = () => {
    const name = ROOM_LABELS[el.dataset.room] || el.dataset.room;
    showTooltip(el, name);
  };
  el.onmouseleave = hideTooltip;
});

// ══════════════════════════════════════════════════════════════════════════════
// URL Hash
// ══════════════════════════════════════════════════════════════════════════════
function updateHash() {
  const parts = [];
  if (currentDay !== 'all') parts.push(`day=${currentDay}`);
  if (selectedRoom) parts.push(`room=${selectedRoom}`);
  if (currentView !== 'room') parts.push(`view=${currentView}`);
  window.location.hash = parts.join('&');
}

function handleHash() {
  const hash = window.location.hash.slice(1);
  if (!hash) return;

  const params = new URLSearchParams(hash);
  const day = params.get('day');
  const room = params.get('room');
  const view = params.get('view');

  if (day && day !== currentDay) setDay(day);
  if (view && view !== currentView) switchPanel(view);
  if (room) {
    const el = document.querySelector(`.room[data-room="${room}"]`);
    if (el) selectRoom(el);
  }
}

window.addEventListener('hashchange', handleHash);

// ══════════════════════════════════════════════════════════════════════════════
// Init
// ══════════════════════════════════════════════════════════════════════════════
function init() {
  renderDayTabs();
  updateRoomStates();
  updateProgressRings();
  createRoomStatusBars();
  updateAllStatusBars();
  handleHash();

  const addr = EVENT_DATA.venue && EVENT_DATA.venue.address ? EVENT_DATA.venue.address : '';
  document.getElementById('venueAddr').textContent = addr;
}

init();
</script>
</body>
</html>
