<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Convene Willis Tower — Floor Plan</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=Source+Code+Pro:wght@400;500&display=swap');

  :root {
    /* ── Ground & Surfaces ── */
    --text:        #161616;    /* maximum contrast */
    --text-light:  #393939;    /* secondary — strong enough to read */
    --text-muted:  #565656;    /* tertiary — still legible on light bg */
    --ground:      #f2f4f8;    /* cool blue-white — professional, not dead */
    --cream:       #e0e0e0;    /* Gray 30 — dividers, tracks, input bgs */
    --white:       #ffffff;    /* cards, panels */
    --shadow-near: hsla(25, 40%, 30%, 0.08);
    --shadow-far:  hsla(25, 30%, 40%, 0.05);
    --radius:      8px;
    --radius-sm:   6px;

    /* ── Type Scale (IBM productive mode) ── */
    --type-xs:     0.75rem;    /* 12px — labels, metadata */
    --type-sm:     0.8125rem;  /* 13px — captions, buttons */
    --type-base:   0.875rem;   /* 14px — body, checklist items */
    --type-md:     1rem;       /* 16px — section headers */
    --type-lg:     1.125rem;   /* 18px — room names */
    --type-xl:     1.25rem;    /* 20px — page title */

    /* ── Spacing Scale ── */
    --space-2xs:   6px;
    --space-xs:    10px;
    --space-sm:    16px;
    --space-md:    24px;
    --space-lg:    40px;
    --space-xl:    64px;

    /* ── Room Fill Ramp (saturated blue, bright even when light) ── */
    --room-empty:    #e8f0fe;    /* sky tint — no gear */
    --room-light:    #c2d8fc;    /* periwinkle wash — some gear */
    --room-moderate: #8ab4f8;    /* cornflower — populated */
    --room-heavy:    #5994f0;    /* bright blue — substantial */
    --room-dense:    #3478e8;    /* vivid blue — packed, white text safe */

    /* ── Room Stroke (saturated to match fills) ── */
    --stroke-empty:    #c4d4f0;
    --stroke-light:    #a0bce8;
    --stroke-moderate: #6e9ae0;
    --stroke-heavy:    #4a80d8;
    --stroke-dense:    #2a68cc;

    /* ── Status Colors (IBM-derived, production-mapped) ── */
    --status-set:    #198038;   /* IBM Green 60 — "placed, go" */
    --status-test:   #0f62fe;   /* IBM Blue 60 — "verified, signal present" */
    --status-ready:  #f1c21b;   /* IBM Yellow 30 — "complete, amber work light" */
    --status-flag:   #da1e28;   /* IBM Red 60 — "problem, stop" */

    /* ── Setup Intensity Ramp (--status-set based) ── */
    --set-0-fill:    #f4f4f4;
    --set-0-stroke:  #d8d8d8;
    --set-1-fill:    rgba(25, 128, 56, 0.10);
    --set-1-stroke:  rgba(25, 128, 56, 0.40);
    --set-2-fill:    rgba(25, 128, 56, 0.22);
    --set-2-stroke:  rgba(25, 128, 56, 0.58);
    --set-3-fill:    rgba(25, 128, 56, 0.36);
    --set-3-stroke:  rgba(25, 128, 56, 0.72);
    --set-4-fill:    rgba(25, 128, 56, 0.50);
    --set-4-stroke:  rgba(25, 128, 56, 0.88);

    /* ── Test Intensity Ramp (--status-test based) ── */
    --test-0-fill:   #f4f4f4;
    --test-0-stroke: #d8d8d8;
    --test-1-fill:   rgba(15, 98, 254, 0.10);
    --test-1-stroke: rgba(15, 98, 254, 0.40);
    --test-2-fill:   rgba(15, 98, 254, 0.22);
    --test-2-stroke: rgba(15, 98, 254, 0.58);
    --test-3-fill:   rgba(15, 98, 254, 0.38);
    --test-3-stroke: rgba(15, 98, 254, 0.72);
    --test-4-fill:   rgba(15, 98, 254, 0.52);
    --test-4-stroke: rgba(15, 98, 254, 0.88);

    /* ── Accent / Selection (IBM Blue) ── */
    --accent:        #0f62fe;   /* IBM Blue — selected/focused state */
    --accent-hover:  rgba(15, 98, 254, 0.10);
    --accent-glow:   rgba(15, 98, 254, 0.20);

    /* ── Category Border Colors (production color coding) ── */
    --cat-audio:         #198038;   /* green — audio channel */
    --cat-video:         #0f62fe;   /* blue — video channel */
    --cat-control:       #8a3ffc;   /* IBM Purple 60 — control systems */
    --cat-presentation:  #f1c21b;   /* yellow — content/presentation */
    --cat-cables:        #8d8d8d;   /* gray — infrastructure */

    /* ── Type Badges ── */
    --badge-meeting:  #0f62fe;
    --badge-studio:   #8a3ffc;
    --badge-service:  #8d8d8d;
    --badge-gallery:  #e0e0e0;

    /* ── Easing ── */
    --ease-smooth:  cubic-bezier(0.22, 0.61, 0.36, 1);
    --ease-spring:  cubic-bezier(0.34, 1.56, 0.64, 1);
    --ease-settle:  cubic-bezier(0.25, 0.46, 0.45, 0.94);

    /* ── Typography ── */
    --font-display: 'IBM Plex Sans', system-ui, sans-serif;
    --font-body:    'IBM Plex Sans', system-ui, sans-serif;
    --font-mono:    'Source Code Pro', monospace;

    /* ── Sidebar Dimensions ── */
    --sidebar-collapsed:  280px;
    --sidebar-expanded:   420px;
    --sidebar-transition: 300ms;
  }

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background-color: var(--ground);
    color: var(--text);
    font-family: var(--font-body);
    line-height: 1.6;
    padding: var(--space-md);
  }

  /* ─── Page Layout ─── */
  .page { max-width: 1200px; margin: 0 auto; }

  header {
    display: flex; align-items: baseline; gap: 1rem;
    margin-bottom: 0.75rem; flex-wrap: wrap;
  }
  header h1 {
    font-family: var(--font-display); font-size: 1.5rem; font-weight: 600; letter-spacing: -0.02em;
  }
  header .addr {
    font-family: var(--font-mono); font-size: var(--type-sm); color: var(--text-muted);
    display: none;
  }

  /* ─── Toolbar ─── */
  .toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
    flex-wrap: wrap;
  }

  .day-switcher {
    display: flex;
    gap: var(--space-2xs);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    cursor: grab;
    user-select: none;
  }
  .day-switcher:active { cursor: grabbing; }

  .day-tab {
    font-family: var(--font-body);
    font-size: var(--type-sm);
    font-weight: 500;
    padding: 0.35rem 0.75rem;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    border: 1px solid var(--cream);
    border-radius: 20px;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s var(--ease-smooth), transform 0.15s var(--ease-spring);
    white-space: nowrap;
  }
  .day-tab:active { transform: scale(0.95); }
  .day-tab:hover {
    background: var(--cream);
    color: var(--text);
  }
  .day-tab.active {
    background: var(--accent);
    color: var(--white);
    border-color: var(--accent);
  }
  .day-tab .day-label {
    font-size: var(--type-xs);
    opacity: 0.8;
    margin-left: 0.3rem;
  }

  /* ─── Progress Rings ─── */
  .progress-rings {
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }
  .ring-group {
    display: flex;
    align-items: center;
    gap: 0.2rem;
  }
  .ring-wrap {
    width: 42px;
    height: 42px;
    position: relative;
  }
  .ring-wrap svg {
    transform: rotate(-90deg);
    width: 42px;
    height: 42px;
  }
  .ring-track {
    fill: none;
    stroke: var(--cream);
    stroke-width: 3;
  }
  .ring-fill {
    fill: none;
    stroke-width: 3;
    stroke-linecap: round;
    transition: stroke-dashoffset 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .ring-fill-set { stroke: var(--status-set); }
  .ring-fill-test { stroke: var(--status-test); }
  .ring-fill-ready { stroke: var(--status-ready); }
  .ring-pct {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    font-weight: 500;
    color: var(--text-light);
  }
  .ring-label {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    font-weight: 500;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    color: var(--text-muted);
  }

  .search-box {
    position: relative;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .search-box input {
    font-family: var(--font-mono);
    font-size: var(--type-sm);
    padding: 0.4rem 0.8rem;
    border: 1px solid var(--cream);
    border-radius: 20px;
    background: var(--cream);
    color: var(--text);
    width: 190px;
    outline: none;
    transition: border-color 0.2s, width 0.3s var(--ease-smooth),
                background 0.2s, box-shadow 0.25s ease;
  }
  .search-box input:focus {
    border-color: var(--accent);
    background: var(--white);
    width: 230px;
    box-shadow: 0 0 0 3px var(--accent-hover);
  }
  .search-box input::placeholder { color: var(--text-muted); }

  .search-count {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    color: var(--accent);
    opacity: 0;
    transition: opacity 0.2s;
    white-space: nowrap;
  }
  .search-count.visible { opacity: 1; }

  /* ─── Mobile-only elements (hidden on desktop) ─── */
  .mobile-view-tabs { display: none; }
  .room-selector { display: none; }
  .mobile-back { display: none; }
  .hidden { display: none !important; }
  .room-chip {
    font-family: var(--font-body);
    font-size: var(--type-sm);
    font-weight: 500;
    padding: 0.5rem 0.85rem;
    border: 1px solid var(--cream);
    border-radius: var(--radius-sm);
    background: var(--white);
    color: var(--text);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    flex-shrink: 0;
    text-align: left;
    line-height: 1.3;
  }
  .room-chip:active { transform: scale(0.97); }
  .room-chip.active {
    background: var(--accent);
    color: var(--white);
    border-color: var(--accent);
  }
  .room-chip .chip-count {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    color: var(--text-muted);
    margin-left: 0.3rem;
  }
  .room-chip.active .chip-count { color: rgba(255,255,255,0.75); }

  /* ─── Mobile Day Progress (hidden on desktop) ─── */
  .mobile-progress { display: none; }
  .mprog-row {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .mprog-label {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    font-weight: 500;
    color: var(--text-muted);
    width: 2.5rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  .mprog-track {
    flex: 1;
    height: 6px;
    background: var(--cream);
    border-radius: 3px;
    overflow: hidden;
  }
  .mprog-fill {
    height: 100%;
    border-radius: 3px;
    width: 0%;
    transition: width 0.4s var(--ease-smooth);
  }
  .mprog-fill-set { background: var(--status-set); }
  .mprog-fill-test { background: var(--status-test); }
  .mprog-pct {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    color: var(--text-light);
    width: 2rem;
    text-align: right;
  }

  /* ─── Main Grid ─── */
  .plan-layout {
    display: grid;
    grid-template-columns: 1fr var(--sidebar-collapsed);
    gap: var(--space-md);
    align-items: start;
    transition: grid-template-columns var(--sidebar-transition) var(--ease-smooth);
  }

  .plan-layout.room-selected {
    grid-template-columns: 1fr var(--sidebar-expanded);
  }

  .plan-layout.full-view {
    grid-template-columns: 0fr 1fr;
  }
  .plan-layout.full-view .plan-card {
    overflow: hidden;
    opacity: 0;
    pointer-events: none;
    max-height: 0;
    padding: 0;
    margin: 0;
  }
  .plan-layout.full-view .detail-panel {
    width: 100%;
    max-height: none;
  }

  @media (max-width: 860px) {
    /* ══════════════════════════════════════
       MOBILE: Completely different layout.
       No map. Room selector + detail panel.
       ══════════════════════════════════════ */

    html, body {
      overflow-x: hidden;
      margin: 0;
      padding: 0;
      width: 100%;
      max-width: 100%;
    }
    .page {
      padding: var(--space-sm);
      padding-bottom: 0;
      overflow-x: hidden;
      width: 100%;
      max-width: 100vw;
      box-sizing: border-box;
    }

    /* Header — compact */
    header {
      flex-direction: column;
      gap: 0.1rem;
      margin-bottom: 0.5rem;
    }
    header h1 { font-size: var(--type-lg); line-height: 1.3; }
    header .addr { font-size: var(--type-xs); }

    /* Toolbar — vertical, tight */
    .toolbar {
      flex-direction: column;
      align-items: stretch;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
    }

    /* Day tabs — native momentum scroll */
    .day-switcher {
      display: flex;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-x: contain;
      scrollbar-width: none;
      flex-wrap: nowrap;
      margin: 0;
      padding: 0.25rem var(--space-sm);
      gap: 0.5rem;
      -webkit-user-select: none;
      user-select: none;
    }
    .day-switcher::-webkit-scrollbar { display: none; }
    .day-tab {
      flex: 0 0 auto;
      font-size: var(--type-sm);
      padding: 0.5rem 1rem;
      min-width: 100px;
      text-align: center;
      white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
    }

    /* Progress rings — hide */
    .progress-rings { display: none; }

    /* Search — full width */
    .search-box { width: 100%; }
    .search-box input { width: 100%; }
    .search-box input:focus { width: 100%; }

    /* ── Mobile view tabs — show ── */
    .mobile-view-tabs { display: flex; }

    /* ── Room List — vertical, default view on mobile ── */
    .room-selector {
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    .room-chip {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.85rem 0.5rem;
      border-radius: 0;
      border: none;
      border-bottom: 1px solid var(--cream);
      background: transparent;
      font-size: var(--type-base);
      font-weight: 500;
    }
    .room-chip:nth-child(odd) { background: rgba(224, 224, 224, 0.18); }
    .room-chip:last-child { border-bottom: none; }
    .room-chip:active { background: var(--accent-hover); }
    .room-chip.active {
      background: var(--accent-hover);
      color: var(--text);
      border-color: var(--accent);
      border-left: 3px solid var(--accent);
    }
    .room-chip .chip-count {
      font-family: var(--font-mono);
      font-size: var(--type-xs);
      font-weight: 500;
      color: var(--text-light);
      margin-left: auto;
      background: var(--cream);
      padding: 0.1rem 0.45rem;
      border-radius: 8px;
      min-width: 1.6rem;
      text-align: center;
    }
    .room-chip.active .chip-count {
      background: var(--accent);
      color: var(--white);
    }

    /* Room list hides when a room is selected */
    .room-selector.hidden { display: none; }

    /* ── Mobile day progress — show ── */
    .mobile-progress {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      padding: 0.5rem 0;
    }

    /* ── Hide the entire map + grid ── */
    .plan-layout { display: block; }
    .plan-card { display: none; }

    /* ── Detail panel — static, full width ── */
    .detail-panel,
    .detail-panel.expanded {
      position: static !important;
      transform: none !important;
      width: 100% !important;
      max-height: none;
      border-radius: var(--radius);
      border: 1px solid var(--cream);
      box-shadow: 0 1px 3px var(--shadow-near);
      padding: var(--space-sm);
      overflow-y: visible;
      top: auto;
    }

    /* Detail panel hides until a room is selected or pull sheet is shown */
    .detail-panel:not(.mobile-active) { display: none !important; }

    /* Hide full-view tab on mobile */
    .panel-tab-fullview { display: none; }

    /* Panel tabs — stronger contrast on mobile */
    .panel-tabs {
      margin-bottom: 0.6rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--cream);
    }
    .panel-tab {
      font-size: var(--type-sm);
      padding: 0.3rem 0.7rem;
    }
    .panel-tab.active {
      background: var(--text);
      color: var(--white);
      border-color: var(--text);
    }

    /* Show panel tabs in the room list area instead */
    .mobile-view-tabs {
      display: flex;
      gap: 0.3rem;
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--cream);
    }
    .mobile-view-tab {
      font-family: var(--font-body);
      font-size: var(--type-sm);
      font-weight: 500;
      padding: 0.35rem 0.75rem;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      border: 1px solid transparent;
      border-radius: 20px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
    }
    .mobile-view-tab.active {
      background: var(--text);
      color: var(--white);
      border-color: var(--text);
    }

    /* Hide drag handle */
    .drag-handle { display: none !important; }

    /* Back button */
    .mobile-back {
      display: none;
      font-family: var(--font-body);
      font-size: var(--type-sm);
      font-weight: 600;
      color: var(--accent);
      background: none;
      border: none;
      padding: 0.5rem 0;
      cursor: pointer;
      margin-bottom: 0.15rem;
    }

    /* Detail content spacing on mobile */
    .detail-header { margin-top: 0.25rem; }
    .detail-meta { margin-bottom: 0.6rem; }
    .compact-progress { margin-top: 0.5rem; margin-bottom: 0.25rem; }

    /* Legend — hide */
    .legend { display: none; }

    /* Checklist rows — prevent overflow */
    .checklist-row {
      grid-template-columns: 40px 40px 1fr auto;
      padding: var(--space-xs) 0.25rem;
      gap: 6px;
      border-bottom: 1px solid rgba(224, 224, 224, 0.5);
    }
    .check-col { min-width: 0; }

    /* Section labels — more breathing room on mobile */
    .detail-section-label {
      margin: var(--space-sm) 0 var(--space-xs);
      padding-left: var(--space-xs);
    }

    /* Detail content — contain overflow */
    .detail-panel { overflow-x: hidden; }
  }

  /* ─── SVG Card ─── */
  .plan-card {
    background: var(--white);
    border: 1px solid var(--cream);
    border-radius: var(--radius);
    box-shadow: 0 1px 3px var(--shadow-near), 0 8px 24px var(--shadow-far);
    padding: var(--space-md);
    overflow: hidden;
    position: relative;
    transition: box-shadow 0.3s ease;
  }
  .plan-card:hover {
    box-shadow: 0 2px 6px var(--shadow-near), 0 12px 32px var(--shadow-far);
  }
  .plan-card svg { width: 100%; height: auto; display: block; }

  /* ─── SVG Room Styles ─── */
  .building-outline {
    fill: none; stroke: var(--cream); stroke-width: 0.8;
  }
  .corridor {
    fill: rgba(224, 224, 224, 0.06); stroke: none;
  }

  .room {
    cursor: pointer;
    stroke-width: 0.7;
    transition: fill 0.3s var(--ease-smooth), stroke 0.3s var(--ease-smooth),
                filter 0.25s ease-out, stroke-width 0.2s var(--ease-smooth),
                opacity 0.3s ease;
    transform-origin: center;
  }
  .room:hover {
    filter: brightness(0.92) drop-shadow(0 0 10px var(--accent-glow));
    stroke-width: 1.6;
  }
  .room:active {
    filter: brightness(0.88) drop-shadow(0 0 12px var(--accent-glow));
    stroke-width: 2;
  }
  .room:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
  .room.selected {
    stroke: var(--accent);
    stroke-width: 1.5;
  }

  .room.i0 { fill: var(--room-empty); stroke: var(--stroke-empty); filter: url(#room-depth-empty); }
  .room.i1 { fill: var(--room-light); stroke: var(--stroke-light); filter: url(#room-depth); }
  .room.i2 { fill: var(--room-moderate); stroke: var(--stroke-moderate); filter: url(#room-depth); }
  .room.i3 { fill: var(--room-heavy); stroke: var(--stroke-heavy); filter: url(#room-depth); }
  .room.i4 { fill: var(--room-dense); stroke: var(--stroke-dense); filter: url(#room-depth); }

  .room.dimmed {
    opacity: 0.30;
    transition: opacity 200ms var(--ease-smooth);
  }

  /* Search states */
  .room.search-dim {
    opacity: 0.2;
  }
  .room.search-match {
    stroke: var(--accent) !important;
    stroke-width: 2 !important;
  }

  /* ─── SVG Status Bars ─── */
  .status-track-rect {
    fill: rgba(224, 224, 224, 0.6);
    pointer-events: none;
  }
  .status-set-rect {
    fill: var(--status-set);
    pointer-events: none;
    opacity: 0.85;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .status-test-rect {
    fill: var(--status-test);
    pointer-events: none;
    opacity: 0.85;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  #statusBars g {
    transition: opacity 0.4s ease;
  }

  /* ─── Minimal Transitions (no staggered animations) ─── */
  .check-box.popping {
    transition: transform 0.15s var(--ease-smooth);
  }

  /* Status bar smooth fill */
  .compact-fill {
    transition: width 0.6s var(--ease-smooth);
  }


  .divider-line {
    stroke: var(--stroke-empty); stroke-width: 0.5; stroke-dasharray: 3 2;
  }

  .label-room {
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 14px; font-weight: 600;
    fill: var(--text); text-anchor: middle;
    pointer-events: none;
    dominant-baseline: central;
  }
  .label-room.gallery { font-size: 13px; font-weight: 600; }
  .label-room.sm { font-size: 12px; fill: var(--text); font-weight: 500; }
  .label-room.xs { font-size: 12px; fill: var(--text-light); font-weight: 500; }

  .label-count {
    font-family: 'Source Code Pro', monospace;
    font-size: 12px; font-weight: 400;
    fill: var(--text-muted); text-anchor: middle;
    pointer-events: none;
    dominant-baseline: central;
    transition: opacity 0.3s;
  }

  .label-sub {
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 12px; font-weight: 400;
    fill: var(--text-muted); text-anchor: middle;
    pointer-events: none;
    dominant-baseline: central;
  }

  /* ── Room Type Differentiation ── */
  .room-gallery  { stroke-width: 0.9; }
  .room-meeting  { stroke-width: 0.8; }
  .room-studio   { stroke-width: 0.7; }
  .room-service  { stroke-width: 0.5; stroke-dasharray: 4 2; }

  .entrance-marker {
    fill: var(--accent); stroke: none; opacity: 0.6;
  }
  .entrance-label {
    font-family: 'Source Code Pro', monospace;
    font-size: 12px; fill: var(--text-light);
    text-anchor: middle; letter-spacing: 0.5px;
  }

  /* ─── Legend ─── */
  .legend {
    display: flex; align-items: center; gap: 0.4rem;
    margin-top: 1rem; padding-top: 0.75rem;
    border-top: 1px solid var(--cream);
    flex-wrap: wrap;
  }
  .legend-title {
    font-family: var(--font-mono); font-size: var(--type-sm);
    color: var(--text-muted); text-transform: uppercase;
    letter-spacing: 0.06em; margin-right: 0.25rem;
  }
  .legend-step { display: flex; align-items: center; gap: 0.3rem; }
  .legend-swatch { width: 24px; height: 14px; border-radius: 3px; }
  .sw-0 { background: var(--room-empty); border: 1px solid var(--stroke-empty); }
  .sw-1 { background: var(--room-light); border: 1px solid var(--stroke-light); }
  .sw-2 { background: var(--room-moderate); border: 1px solid var(--stroke-moderate); }
  .sw-3 { background: var(--room-heavy); border: 1px solid var(--stroke-heavy); }
  .sw-4 { background: var(--room-dense); border: 1px solid var(--stroke-dense); }
  .legend-label { font-family: var(--font-body); font-size: var(--type-xs); color: var(--text-muted); }
  .legend-sep { color: var(--stroke-moderate); font-size: var(--type-xs); margin: 0 0.1rem; }

  /* Legend mode toggle */
  .legend-modes {
    display: flex;
    gap: 0.2rem;
    margin-left: auto;
  }
  .legend-mode-btn {
    font-family: var(--font-mono);
    font-size: var(--type-sm);
    padding: 4px 10px;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    border: 1px solid var(--cream);
    border-radius: 10px;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s var(--ease-smooth), transform 0.12s var(--ease-spring);
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  .legend-mode-btn:active { transform: scale(0.95); }
  .legend-mode-btn:hover {
    background: var(--cream);
    color: var(--text);
  }
  .legend-mode-btn.active {
    background: var(--accent);
    color: var(--white);
    border-color: var(--accent);
  }

  /* ─── Detail Panel ─── */
  .detail-panel {
    background: var(--white);
    border: 1px solid var(--cream);
    border-radius: var(--radius);
    box-shadow: 0 1px 3px var(--shadow-near), 0 8px 24px var(--shadow-far);
    padding: var(--space-md);
    position: sticky; top: 1.5rem;
    max-height: calc(100vh - 3rem);
    overflow-y: auto;
    width: var(--sidebar-collapsed);
    transition: width var(--sidebar-transition) var(--ease-smooth),
                box-shadow 0.3s ease;
  }
  .drag-handle {
    display: none;
    width: 36px; height: 4px;
    background: var(--cream);
    border-radius: 2px;
    margin: 0 auto var(--space-xs);
    cursor: grab;
  }
  .drag-handle:active { cursor: grabbing; }

  .detail-panel.expanded {
    width: var(--sidebar-expanded);
  }

  /* Panel tabs */
  .panel-tabs {
    display: flex;
    gap: 0.2rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--cream);
  }
  .panel-tab {
    font-family: var(--font-body);
    font-size: var(--type-sm);
    font-weight: 500;
    padding: 0.22rem 0.6rem;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    border: 1px solid transparent;
    border-radius: 6px;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
  }
  .panel-tab:hover {
    color: var(--text);
    background: rgba(224, 224, 224, 0.5);
  }
  .panel-tab.active {
    color: var(--text);
    background: var(--cream);
    border-color: hsla(220, 10%, 30%, 0.06);
  }
  .panel-tab-fullview {
    margin-left: auto;
    font-size: var(--type-xs);
    opacity: 0.6;
  }
  .panel-tab-fullview:hover { opacity: 1; }
  .panel-tab-fullview.active {
    background: var(--accent);
    color: var(--white);
    border-color: var(--accent);
    opacity: 1;
  }

  /* Room detail */
  .detail-empty {
    text-align: center; padding: 2rem 1rem;
    color: var(--text-muted); font-size: var(--type-base);
    line-height: 1.6;
  }
  .detail-empty .hint {
    display: block; margin-top: 0.4rem;
    font-size: var(--type-sm); opacity: 0.7;
  }

  .detail-header {
    font-family: var(--font-display);
    font-size: var(--type-xl); font-weight: 600;
    margin-bottom: var(--space-2xs); line-height: 1.3;
    letter-spacing: -0.01em;
  }

  .detail-meta {
    display: flex; align-items: center; gap: 0.6rem;
    margin-bottom: 0.4rem; flex-wrap: wrap;
  }

  .detail-type {
    font-family: var(--font-mono); font-size: var(--type-xs);
    text-transform: uppercase; letter-spacing: 0.06em;
    padding: 0.15rem 0.55rem; border-radius: 10px;
    color: var(--white);
  }
  .dt-meeting { background: var(--badge-meeting); }
  .dt-studio { background: var(--badge-studio); }
  .dt-service { background: var(--badge-service); }
  .dt-gallery { background: var(--badge-gallery); color: var(--text); }

  .detail-count {
    font-family: var(--font-mono); font-size: var(--type-sm);
    color: var(--text-muted);
  }

  /* Tags row */
  .detail-tags {
    display: flex;
    gap: 0.2rem;
    flex-wrap: wrap;
    margin-bottom: 0.5rem;
  }
  .detail-tag {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    font-weight: 500;
    padding: 3px 8px;
    border-radius: 4px;
  }
  .tag-crew { background: rgba(138, 63, 252, 0.08); color: var(--cat-control); }
  .tag-zoom { background: rgba(25, 128, 56, 0.08); color: var(--cat-audio); }
  .tag-vendor { background: rgba(218, 30, 40, 0.06); color: var(--status-flag); }
  .tag-day { background: var(--cream); color: var(--text-light); }

  .detail-crew {
    font-family: var(--font-mono);
    font-size: var(--type-sm);
    color: var(--text-light);
    margin-bottom: 0.5rem;
  }

  .detail-section-label {
    font-family: var(--font-mono); font-weight: 500;
    font-size: var(--type-xs); color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.06em;
    margin: var(--space-md) 0 var(--space-xs);
    padding-left: var(--space-sm);
    border-left: 3px solid var(--cream);
  }
  .detail-section-label.cat-audio { border-color: var(--cat-audio); }
  .detail-section-label.cat-video { border-color: var(--cat-video); }
  .detail-section-label.cat-control { border-color: var(--cat-control); }
  .detail-section-label.cat-presentation { border-color: var(--cat-presentation); }
  .detail-section-label.cat-cables { border-color: var(--cat-cables); }

  /* ─── Checklist Rows ─── */
  .checklist-row {
    display: grid;
    grid-template-columns: 36px 36px 1fr auto;
    align-items: start;
    gap: 8px;
    padding: var(--space-xs) var(--space-sm);
    border-bottom: 1px solid rgba(224, 224, 224, 0.3);
    transition: background 0.1s;
  }
  .checklist-row:last-child { border-bottom: none; }
  .checklist-row:hover { background: rgba(224, 224, 224, 0.3); }

  .check-col {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.05rem;
    padding-top: 0.05rem;
    min-width: 44px;
    min-height: 44px;
  }
  .check-box {
    width: 20px;
    height: 20px;
    border: 1.5px solid var(--stroke-moderate);
    border-radius: 3px;
    cursor: pointer;
    transform: scale(1);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s var(--ease-smooth), transform 0.15s var(--ease-spring);
    flex-shrink: 0;
  }
  .check-box:hover { border-color: var(--accent); transform: scale(1.1); }
  .check-box:active { transform: scale(0.9); }
  .check-box.checked { border-color: transparent; }
  .check-box.set-box.checked { background: var(--status-set); }
  .check-box.test-box.checked { background: var(--status-test); }
  .check-box.checked::after {
    content: '';
    width: 4px;
    height: 7px;
    border: solid var(--white);
    border-width: 0 1.5px 1.5px 0;
    transform: rotate(45deg) translate(-0.5px, -0.5px);
  }
  .check-label {
    font-family: var(--font-mono);
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    line-height: 1;
  }
  .check-label.lbl-set { color: var(--status-set); }
  .check-label.lbl-test { color: var(--status-test); }

  .item-info {
    padding-top: 0.05rem;
    min-width: 0;
  }
  .item-name {
    font-size: var(--type-base);
    font-weight: 500;
    line-height: 1.25;
  }
  .item-sub {
    font-size: var(--type-xs);
    color: var(--text-muted);
    line-height: 1.3;
  }
  .item-flag {
    font-size: var(--type-xs);
    font-weight: 600;
    color: var(--status-flag);
  }
  .item-qty {
    font-family: var(--font-mono);
    font-size: var(--type-sm);
    color: var(--text-muted);
    padding-top: 0.1rem;
    text-align: right;
    white-space: nowrap;
  }

  .detail-note {
    font-size: var(--type-base); color: var(--text-light);
    margin-top: 0.75rem;
    padding: var(--space-xs) var(--space-sm);
    background: rgba(224, 224, 224, 0.4);
    border-radius: var(--radius-sm);
    line-height: 1.5;
  }

  /* ─── Room Progress Mini Ring ─── */
  .detail-room-ring {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    margin-left: 0.5rem;
  }
  .detail-ring-wrap {
    width: 22px;
    height: 22px;
    position: relative;
  }
  .detail-ring-wrap svg {
    transform: rotate(-90deg);
    width: 22px;
    height: 22px;
  }

  /* ─── Pull Sheet ─── */
  .pull-header { margin-bottom: 0.75rem; }
  .pull-title {
    font-family: var(--font-display);
    font-size: var(--type-md); font-weight: 600;
  }
  .pull-stats {
    font-family: var(--font-mono);
    font-size: var(--type-sm);
    color: var(--text-muted);
    margin-top: 0.1rem;
  }

  .pull-item {
    display: grid;
    grid-template-columns: 24px 24px 1fr auto;
    align-items: center;
    gap: 0.3rem;
    font-size: var(--type-base);
    padding: 0.22rem 0.65rem;
    border-left: 3px solid transparent;
  }
  .pull-check {
    width: 13px;
    height: 13px;
    border-radius: 2px;
    border: 1.5px solid var(--cream);
  }
  .pull-check.set-done { background: var(--status-set); border-color: var(--status-set); }
  .pull-check.test-done { background: var(--status-test); border-color: var(--status-test); }
  .pull-check.partial { background: var(--cream); border-color: var(--stroke-moderate); }

  .pull-item-name { flex: 1; min-width: 0; }
  .pull-item-rooms {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    color: var(--text-muted);
    text-align: right;
    flex-shrink: 0;
  }

  /* ─── Search Results ─── */
  .search-results-header {
    font-family: var(--font-mono);
    font-size: var(--type-sm);
    color: var(--text-muted);
    margin-bottom: 0.5rem;
  }
  .search-result-item {
    padding: 0.45rem 0.65rem;
    border-left: 3px solid var(--cream);
    margin-bottom: 0.3rem;
    cursor: pointer;
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    transition: background 0.15s;
  }
  .search-result-item:hover {
    background: rgba(224, 224, 224, 0.3);
  }
  .search-result-room {
    font-family: var(--font-display);
    font-size: var(--type-base);
    font-weight: 600;
    display: block;
    margin-bottom: 0.1rem;
  }
  .search-result-matches {
    font-size: var(--type-sm);
    color: var(--text-light);
    line-height: 1.4;
  }

  /* ─── Compact Progress (sidebar summary) ─── */
  .compact-progress {
    margin-top: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }
  .compact-bar {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .compact-label {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    font-weight: 500;
    text-transform: uppercase;
    color: var(--text-muted);
    width: 2.5rem;
  }
  .compact-track {
    flex: 1;
    height: 8px;
    background: #d0d0d0;
    border-radius: 3px;
    overflow: hidden;
  }
  .compact-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .compact-pct {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    color: var(--text-light);
    width: 2rem;
    text-align: right;
  }

  /* ─── Tooltip (disabled — rooms are self-labeling) ─── */
  .svg-tooltip { display: none; }

  /* ─── Accessibility ─── */
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* ─── Print ─── */
  @media print {
    body { padding: 0.5cm; background-image: none; }
    .toolbar { margin-bottom: 0.5cm; }
    .plan-layout { grid-template-columns: 1fr; }
    .plan-card { display: none; }
    .detail-panel {
      position: static;
      max-height: none;
      overflow: visible;
      box-shadow: none;
      page-break-inside: avoid;
    }
    .panel-tabs { display: none; }
    .legend { page-break-inside: avoid; }
    .day-tab { border: 1px solid #ccc; }
    .day-tab.active { background: #666; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .search-box { display: none; }
    .check-box { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .check-box.checked { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .pull-check { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .progress-rings { display: none; }
    .checklist-row:hover { background: transparent; }
  }
  @media print and (not (prefers-reduced-data)) {
    .plan-card { display: block; }
    .plan-layout { grid-template-columns: 1fr var(--sidebar-collapsed); }
  }

  /* ─── Live Data Indicator ─── */
  .live-indicator {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0 0.5rem;
    white-space: nowrap;
  }
  .live-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--status-flag);
    flex-shrink: 0;
    transition: background 0.3s;
  }
  .live-dot.live { background: var(--status-set); }
  .live-dot.cached { background: var(--status-ready); }
  .live-dot.offline { background: var(--status-flag); }
  .live-label {
    font-family: var(--font-mono);
    font-size: var(--type-xs);
    color: var(--text-muted);
  }

  /* ─── Toast Notification ─── */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    font-family: var(--font-body);
    font-size: var(--type-sm);
    font-weight: 500;
    color: var(--white);
    background: var(--text);
    padding: 0.6rem 1.2rem;
    border-radius: var(--radius);
    box-shadow: 0 4px 16px var(--shadow-near);
    opacity: 0;
    pointer-events: none;
    transition: opacity 300ms var(--ease-smooth), transform 300ms var(--ease-smooth);
    z-index: 1000;
  }
  .toast.visible {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  @media print {
    .live-indicator { display: none; }
    .toast { display: none; }
  }
</style>
</head>
<body>

<div class="page">

<header>
  <h1 id="venueName">Convene Willis Tower</h1>
  <span class="addr" id="venueAddr"></span>
</header>

<!-- ═══ Toolbar ═══ -->
<div class="toolbar">
  <div class="day-switcher" id="daySwitcher" role="tablist" aria-label="Show day"></div>

  <div class="progress-rings" id="progressRings">
    <div class="ring-group">
      <div class="ring-wrap">
        <svg viewBox="0 0 42 42">
          <circle class="ring-track" cx="21" cy="21" r="17"/>
          <circle class="ring-fill ring-fill-set" cx="21" cy="21" r="17"
                  id="ringSet" stroke-dasharray="106.81" stroke-dashoffset="106.81"/>
        </svg>
        <span class="ring-pct" id="pctSet">0%</span>
      </div>
      <span class="ring-label">Set</span>
    </div>
    <div class="ring-group">
      <div class="ring-wrap">
        <svg viewBox="0 0 42 42">
          <circle class="ring-track" cx="21" cy="21" r="17"/>
          <circle class="ring-fill ring-fill-test" cx="21" cy="21" r="17"
                  id="ringTest" stroke-dasharray="106.81" stroke-dashoffset="106.81"/>
        </svg>
        <span class="ring-pct" id="pctTest">0%</span>
      </div>
      <span class="ring-label">Test</span>
    </div>
    <div class="ring-group">
      <div class="ring-wrap">
        <svg viewBox="0 0 42 42">
          <circle class="ring-track" cx="21" cy="21" r="17"/>
          <circle class="ring-fill ring-fill-ready" cx="21" cy="21" r="17"
                  id="ringReady" stroke-dasharray="106.81" stroke-dashoffset="106.81"/>
        </svg>
        <span class="ring-pct" id="pctReady">0%</span>
      </div>
      <span class="ring-label">Ready</span>
    </div>
  </div>

  <div class="search-box">
    <input type="search" id="searchInput" placeholder="Search gear, rooms, crew..." aria-label="Search equipment">
    <span class="search-count" id="searchCount"></span>
  </div>

  <div class="live-indicator" id="liveIndicator">
    <span class="live-dot" id="liveDot"></span>
    <span class="live-label" id="liveLabel">Offline</span>
  </div>
</div>

<!-- ═══ Mobile View Tabs + Room List (hidden on desktop) ═══ -->
<div class="mobile-view-tabs" id="mobileViewTabs">
  <button class="mobile-view-tab active" data-mview="rooms">Rooms</button>
  <button class="mobile-view-tab" data-mview="pull">Pull Sheet</button>
</div>
<nav class="room-selector" id="roomSelector" aria-label="Select a room"></nav>

<!-- ═══ Mobile Day Progress (hidden on desktop) ═══ -->
<div class="mobile-progress" id="mobileProgress">
  <div class="mprog-row">
    <span class="mprog-label">SET</span>
    <div class="mprog-track"><div class="mprog-fill mprog-fill-set" id="mprogSet"></div></div>
    <span class="mprog-pct" id="mprogSetPct">0%</span>
  </div>
  <div class="mprog-row">
    <span class="mprog-label">TEST</span>
    <div class="mprog-track"><div class="mprog-fill mprog-fill-test" id="mprogTest"></div></div>
    <span class="mprog-pct" id="mprogTestPct">0%</span>
  </div>
</div>

<main class="plan-layout">

<!-- ═══ Floor Plan SVG ═══ -->
<article class="plan-card">
  <svg viewBox="0 0 860 750" xmlns="http://www.w3.org/2000/svg" role="img"
       aria-label="Floor plan of Convene Willis Tower, Floor 3. Click rooms to view equipment details.">
    <defs>
      <filter id="glow-subtle">
        <feGaussianBlur stdDeviation="2" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
      <!-- Warm inset shadow for gear-loaded rooms (i1-i4) -->
      <filter id="room-depth" x="-5%" y="-5%" width="110%" height="120%">
        <feFlood flood-color="hsla(25, 30%, 25%, 1)" flood-opacity="0.12" result="shadow-color"/>
        <feComposite in="shadow-color" in2="SourceGraphic" operator="in" result="shadow-shape"/>
        <feOffset dx="0" dy="1" result="shadow-offset"/>
        <feGaussianBlur stdDeviation="2" result="shadow-blur"/>
        <feComposite in="shadow-blur" in2="SourceGraphic" operator="atop" result="shadow-inset"/>
        <feMerge>
          <feMergeNode in="SourceGraphic"/>
          <feMergeNode in="shadow-inset"/>
        </feMerge>
      </filter>
      <!-- Lighter inset shadow for empty rooms (i0) -->
      <filter id="room-depth-empty" x="-5%" y="-5%" width="110%" height="120%">
        <feFlood flood-color="hsla(25, 30%, 25%, 1)" flood-opacity="0.06" result="shadow-color"/>
        <feComposite in="shadow-color" in2="SourceGraphic" operator="in" result="shadow-shape"/>
        <feOffset dx="0" dy="1" result="shadow-offset"/>
        <feGaussianBlur stdDeviation="1.5" result="shadow-blur"/>
        <feComposite in="shadow-blur" in2="SourceGraphic" operator="atop" result="shadow-inset"/>
        <feMerge>
          <feMergeNode in="SourceGraphic"/>
          <feMergeNode in="shadow-inset"/>
        </feMerge>
      </filter>
    </defs>

    <!-- Building shell + corridors -->
    <rect class="building-outline" x="3" y="18" width="854" height="710" rx="6"/>
    <rect class="corridor" x="95" y="148" width="520" height="290" rx="1"/>
    <rect class="corridor" x="130" y="80" width="480" height="68"/>
    <rect class="corridor" x="225" y="438" width="350" height="30"/>

    <!-- ═══ ADAMS GALLERY ═══ -->
    <rect class="room room-gallery" data-room="adams-g" x="5" y="22" width="395" height="52" rx="8"
          tabindex="0" role="button" aria-label="Adams Gallery"/>
    <text class="label-room gallery" x="203" y="52">Adams Gallery</text>

    <!-- ═══ FORUM ═══ -->
    <rect class="room room-gallery" data-room="forum" x="625" y="22" width="195" height="88" rx="8"
          tabindex="0" role="button" aria-label="Forum Combined"/>
    <text class="label-room" x="722" y="48">Forum</text>
    <text class="label-sub" x="722" y="64">Combined</text>
    <text class="label-count" data-count-for="forum" x="722" y="78"></text>
    <line class="divider-line" x1="625" y1="112" x2="820" y2="112"/>

    <!-- ═══ FORUM SOUTH ═══ -->
    <rect class="room room-studio" data-room="forum-s" x="625" y="113" width="195" height="80" rx="6"
          tabindex="0" role="button" aria-label="Forum South"/>
    <text class="label-room sm" x="722" y="157">Forum South</text>

    <!-- ═══ ADAMS STUDIO ═══ -->
    <rect class="room room-studio" data-room="adams-st" x="5" y="79" width="108" height="55" rx="6"
          tabindex="0" role="button" aria-label="Adams Studio"/>
    <text class="label-room sm" x="59" y="104">Adams Studio</text>
    <text class="label-count" data-count-for="adams-st" x="59" y="121"></text>

    <!-- ═══ BOARDROOMS ═══ -->
    <rect class="room room-meeting" data-room="khan" x="125" y="82" width="78" height="48" rx="6"
          tabindex="0" role="button" aria-label="Khan Boardroom"/>
    <text class="label-room xs" x="164" y="110">Khan</text>

    <rect class="room room-meeting" data-room="olmstead" x="210" y="82" width="78" height="48" rx="6"
          tabindex="0" role="button" aria-label="Olmstead Boardroom"/>
    <text class="label-room xs" x="249" y="110">Olmstead</text>

    <rect class="room room-meeting" data-room="farrand" x="5" y="148" width="120" height="48" rx="6"
          tabindex="0" role="button" aria-label="Farrand Boardroom"/>
    <text class="label-room xs" x="65" y="176">Farrand</text>

    <rect class="room room-meeting" data-room="miller" x="5" y="208" width="70" height="42" rx="6"
          tabindex="0" role="button" aria-label="Miller Boardroom"/>
    <text class="label-room xs" x="40" y="233">Miller</text>

    <!-- ═══ WACKER STUDIO ═══ -->
    <rect class="room room-studio" data-room="wacker-st" x="5" y="262" width="85" height="100" rx="6"
          tabindex="0" role="button" aria-label="Wacker Studio"/>
    <text class="label-room sm" x="48" y="305">Wacker</text>
    <text class="label-sub" x="48" y="320">Studio</text>
    <text class="label-count" data-count-for="wacker-st" x="48" y="337"></text>

    <!-- ═══ WACKER GALLERY ═══ -->
    <rect class="room room-gallery" data-room="wacker-g" x="5" y="374" width="52" height="155" rx="8"
          tabindex="0" role="button" aria-label="Wacker Gallery"/>
    <text class="label-room xs" x="31" y="452" transform="rotate(-90 31 452)">Wacker Gallery</text>

    <!-- ═══ FRANKLIN GALLERY ═══ -->
    <rect class="room room-gallery" data-room="franklin-g" x="625" y="200" width="195" height="228" rx="8"
          tabindex="0" role="button" aria-label="Franklin Gallery"/>
    <text class="label-room gallery" x="722" y="308">Franklin</text>
    <text class="label-sub" x="722" y="326">Gallery</text>

    <!-- ═══ SERVICE ═══ -->
    <rect class="room room-service" data-room="elev" x="265" y="335" width="108" height="48" rx="4"
          tabindex="0" role="button" aria-label="Elevator Bank Hallway"/>
    <text class="label-room xs" x="319" y="363">Elevators</text>

    <rect class="room room-service" data-room="green" x="625" y="432" width="60" height="45" rx="4"
          tabindex="0" role="button" aria-label="Green Room"/>
    <text class="label-room xs" x="655" y="458">Green Rm</text>

    <!-- Entrance marker -->
    <polygon class="entrance-marker" points="185,343 191,353 179,353"/>
    <text class="entrance-label" x="185" y="365">Entrance</text>

    <!-- ═══ HALL ═══ -->
    <rect class="room room-gallery" data-room="hall" x="580" y="482" width="235" height="135" rx="8"
          tabindex="0" role="button" aria-label="Hall Combined"/>
    <text class="label-room" x="698" y="538">Hall</text>
    <text class="label-sub" x="698" y="554">Combined</text>
    <text class="label-count" data-count-for="hall" x="698" y="570"></text>
    <line class="divider-line" x1="580" y1="619" x2="815" y2="619"/>

    <!-- ═══ HALL SOUTH ═══ -->
    <rect class="room room-studio" data-room="hall-s" x="580" y="621" width="235" height="90" rx="6"
          tabindex="0" role="button" aria-label="Hall South"/>
    <text class="label-room" x="698" y="662">Hall South</text>
    <text class="label-count" data-count-for="hall-s" x="698" y="679"></text>

    <!-- ═══ HUB ═══ -->
    <rect class="room room-gallery" data-room="hub" x="5" y="535" width="215" height="118" rx="8"
          tabindex="0" role="button" aria-label="Hub"/>
    <text class="label-room" x="113" y="590">Hub</text>
    <text class="label-count" data-count-for="hub" x="113" y="608"></text>

    <!-- ═══ JACKSON GALLERY ═══ -->
    <rect class="room room-gallery" data-room="jackson-g" x="225" y="558" width="340" height="92" rx="8"
          tabindex="0" role="button" aria-label="Jackson Gallery"/>
    <text class="label-room gallery" x="395" y="608">Jackson Gallery</text>

    <!-- Terraces (decorative) -->
    <rect x="3" y="732" width="120" height="14" rx="2" fill="none" stroke="var(--cream)" stroke-width="0.4" stroke-dasharray="3 2"/>
    <rect x="340" y="732" width="130" height="14" rx="2" fill="none" stroke="var(--cream)" stroke-width="0.4" stroke-dasharray="3 2"/>
    <rect x="620" y="732" width="200" height="14" rx="2" fill="none" stroke="var(--cream)" stroke-width="0.4" stroke-dasharray="3 2"/>
  </svg>

  <nav class="legend" aria-label="Gear density legend">
    <span class="legend-title" id="legendTitle">Gear Load</span>
    <div class="legend-step"><div class="legend-swatch sw-0"></div><span class="legend-label" data-lbl="0">Empty</span></div>
    <span class="legend-sep">&rsaquo;</span>
    <div class="legend-step"><div class="legend-swatch sw-1"></div><span class="legend-label" data-lbl="1">Light</span></div>
    <span class="legend-sep">&rsaquo;</span>
    <div class="legend-step"><div class="legend-swatch sw-2"></div><span class="legend-label" data-lbl="2">Moderate</span></div>
    <span class="legend-sep">&rsaquo;</span>
    <div class="legend-step"><div class="legend-swatch sw-3"></div><span class="legend-label" data-lbl="3">Heavy</span></div>
    <span class="legend-sep">&rsaquo;</span>
    <div class="legend-step"><div class="legend-swatch sw-4"></div><span class="legend-label" data-lbl="4">Dense</span></div>

    <div class="legend-modes">
      <button class="legend-mode-btn active" data-mode="gear">Gear</button>
      <button class="legend-mode-btn" data-mode="setup">Setup</button>
      <button class="legend-mode-btn" data-mode="test">Test</button>
    </div>
  </nav>
</article>

<!-- ═══ Detail Panel ═══ -->
<aside class="detail-panel" id="detailPanel" role="complementary" aria-label="Room equipment details">
  <div class="drag-handle" id="dragHandle" aria-hidden="true"></div>
  <button class="mobile-back" id="mobileBack">← All Rooms</button>

  <div class="panel-tabs">
    <button class="panel-tab active" data-view="room">Room</button>
    <button class="panel-tab" data-view="pull">Pull Sheet</button>
    <button class="panel-tab panel-tab-fullview" data-view="full">Full View</button>
  </div>

  <div id="roomView">
    <div class="detail-empty" id="detailEmpty">
      Click a room to see equipment
      <span class="hint">Or press Tab to navigate, Enter to select</span>
    </div>
    <div id="detailContent" style="display:none" aria-live="polite"></div>
  </div>

  <div id="searchResultsView" style="display:none">
    <div id="searchResults" aria-live="polite"></div>
  </div>

  <div id="pullView" style="display:none">
    <div id="pullContent"></div>
  </div>
</aside>

</main>
</div>

<!-- Tooltip element -->
<div class="svg-tooltip" id="tooltip"></div>

<!-- Toast notification for live data updates -->
<div class="toast" id="toast">Data updated</div>

<script src="data/g2-conference.js"></script>
<script>
/* ═══════════════════════════════════════════
   STATE MANAGER — localStorage-backed checklist state
   ═══════════════════════════════════════════ */

const StateManager = {
  _key: null,
  _state: {},

  init(eventId) {
    this._key = 'checklist-' + eventId;
    try {
      const raw = localStorage.getItem(this._key);
      if (raw) this._state = JSON.parse(raw);
    } catch (e) { /* fresh state */ }
    return this;
  },

  _save() {
    try { localStorage.setItem(this._key, JSON.stringify(this._state)); }
    catch (e) { /* storage full — degrade gracefully */ }
  },

  _itemKey(roomId, day, itemIdx) {
    return roomId + '|' + day + '|' + itemIdx;
  },

  toggle(roomId, day, itemIdx, type) {
    const k = this._itemKey(roomId, day, itemIdx);
    if (!this._state[k]) this._state[k] = {};
    this._state[k][type] = this._state[k][type] ? 0 : 1;
    this._save();
    return this._state[k][type];
  },

  isChecked(roomId, day, itemIdx, type) {
    const k = this._itemKey(roomId, day, itemIdx);
    return this._state[k] && this._state[k][type] ? true : false;
  },

  getRoomProgress(roomId, day, totalItems) {
    let set = 0, test = 0;
    for (let i = 0; i < totalItems; i++) {
      if (this.isChecked(roomId, day, i, 'set')) set++;
      if (this.isChecked(roomId, day, i, 'test')) test++;
    }
    return { set, test, total: totalItems };
  },

  getDayProgress(day) {
    let setCount = 0, testCount = 0, total = 0;
    for (const [roomId, room] of Object.entries(EVENT_DATA.rooms)) {
      const dayData = getRoomDay(roomId, day);
      const flat = flattenItems(dayData.items);
      total += flat.length;
      for (let i = 0; i < flat.length; i++) {
        if (this.isChecked(roomId, day, i, 'set')) setCount++;
        if (this.isChecked(roomId, day, i, 'test')) testCount++;
      }
    }
    return { set: setCount, test: testCount, total };
  },
};

/* ═══════════════════════════════════════════
   LIVE DATA — fetch from Google Apps Script API
   ═══════════════════════════════════════════ */

const LIVE_API_URL = ''; // Set to Apps Script deployment URL to enable live data

const DataLoader = {
  _hash: '',
  _pollTimer: null,
  _POLL_VISIBLE: 30000,   // 30s when tab is visible
  _POLL_HIDDEN: 120000,   // 2min when tab is hidden
  _CACHE_KEY: 'floorplan-data-cache',

  init() {
    if (!LIVE_API_URL) {
      this.setStatus('offline');
      return;
    }
    this.fetch();
    this.startPolling();
  },

  fetch() {
    const self = this;
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 10000);

    fetch(LIVE_API_URL, { signal: controller.signal })
      .then(function(res) {
        clearTimeout(timeout);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
      })
      .then(function(data) {
        if (data.error) throw new Error(data.error);

        // Cache for offline use
        try { localStorage.setItem(self._CACHE_KEY, JSON.stringify(data)); } catch(e) {}

        // Check if data actually changed
        var newHash = JSON.stringify(data);
        if (newHash === self._hash) return; // No change — skip re-render
        self._hash = newHash;

        // Overwrite the global EVENT_DATA
        EVENT_DATA.event = data.event;
        EVENT_DATA.rooms = data.rooms;

        refreshAllViews();
        self.setStatus('live');
        self.showToast('Data updated');
      })
      .catch(function(err) {
        clearTimeout(timeout);
        // Try localStorage cache
        try {
          var cached = localStorage.getItem(self._CACHE_KEY);
          if (cached) {
            var data = JSON.parse(cached);
            var cachedHash = JSON.stringify(data);
            if (cachedHash !== self._hash) {
              self._hash = cachedHash;
              EVENT_DATA.event = data.event;
              EVENT_DATA.rooms = data.rooms;
              refreshAllViews();
            }
            self.setStatus('cached');
            return;
          }
        } catch(e) {}

        // Neither API nor cache — keep bundled data
        self.setStatus('offline');
      });
  },

  startPolling() {
    const self = this;

    function poll() {
      self._pollTimer = setTimeout(function() {
        self.fetch();
        poll();
      }, document.hidden ? self._POLL_HIDDEN : self._POLL_VISIBLE);
    }
    poll();

    // Adjust rate on visibility change + immediate fetch on re-focus
    document.addEventListener('visibilitychange', function() {
      if (self._pollTimer) {
        clearTimeout(self._pollTimer);
        self._pollTimer = null;
      }
      if (!document.hidden) {
        self.fetch(); // Immediate fetch on tab re-focus
      }
      poll();
    });
  },

  setStatus(status) {
    var dot = document.getElementById('liveDot');
    var label = document.getElementById('liveLabel');
    if (!dot || !label) return;
    dot.className = 'live-dot ' + status;
    var labels = { live: 'Live', cached: 'Cached', offline: 'Offline' };
    label.textContent = labels[status] || 'Offline';
  },

  showToast(msg) {
    var el = document.getElementById('toast');
    if (!el) return;
    el.textContent = msg;
    el.classList.add('visible');
    setTimeout(function() { el.classList.remove('visible'); }, 3000);
  },
};

/**
 * Re-render all data-dependent views after a live data update.
 * Preserves UI state (selected room, scroll position).
 */
function refreshAllViews() {
  // Check if day structure changed (new days added/removed)
  var currentButtons = daySwitcher.querySelectorAll('.day-tab');
  var daysChanged = currentButtons.length !== EVENT_DATA.event.days.length;
  if (!daysChanged) {
    currentButtons.forEach(function(btn, i) {
      if (btn.dataset.day !== EVENT_DATA.event.days[i]) daysChanged = true;
    });
  }

  if (daysChanged) {
    // Rebuild day switcher
    daySwitcher.innerHTML = '';
    EVENT_DATA.event.days.forEach(function(day) {
      var btn = document.createElement('button');
      btn.className = 'day-tab' + (day === currentDay ? ' active' : '');
      btn.dataset.day = day;
      btn.setAttribute('role', 'tab');
      btn.setAttribute('aria-selected', day === currentDay);
      var label = EVENT_DATA.event.dayLabels[day] || '';
      btn.innerHTML = '<span class="day-date">' + day + '</span><span class="day-label">' + label + '</span>';
      btn.addEventListener('click', function() { setDay(day); });
      daySwitcher.appendChild(btn);
    });

    // If current day no longer exists, switch to default
    if (EVENT_DATA.event.days.indexOf(currentDay) === -1) {
      currentDay = EVENT_DATA.event.defaultDay || EVENT_DATA.event.days[0];
    }
  }

  // Update header
  document.getElementById('venueName').textContent = EVENT_DATA.event.venue;
  document.getElementById('venueAddr').textContent = EVENT_DATA.event.address;
  document.title = EVENT_DATA.event.venue + ' \u2014 Floor Plan';

  // Re-render all views
  updateRoomStates();
  renderPullSheet();
  updateProgressRings();
  updateAllStatusBars();
  buildRoomSelector();

  // Refresh room detail if one is selected
  if (selectedEl) {
    renderRoomDetail(selectedEl.dataset.room);
  }
}

/* ═══════════════════════════════════════════
   APP — Data-driven floor plan + checklist
   ═══════════════════════════════════════════ */

if (typeof EVENT_DATA === 'undefined') {
  document.body.innerHTML = '<p style="padding:2rem;color:#8a8580;font-family:sans-serif;">Could not load event data. Serve via a local server or check data/g2-conference.js.</p>';
}

const CAT_META = {
  audio:        { label: 'Audio',        cls: 'cat-audio' },
  video:        { label: 'Video',        cls: 'cat-video' },
  control:      { label: 'Control',      cls: 'cat-control' },
  presentation: { label: 'Presentation', cls: 'cat-presentation' },
  cables:       { label: 'Cables / Power', cls: 'cat-cables' },
};
const CAT_ORDER = ['audio', 'video', 'control', 'presentation', 'cables'];
const RING_CIRC = 2 * Math.PI * 17; // ~106.81 (updated for r=17 rings)

/* ─── State ─── */
let currentDay = EVENT_DATA.event.defaultDay;
let selectedEl = null;
let activePanel = 'room'; // 'room' | 'pull'
let intensityMode = 'gear'; // 'gear' | 'setup' | 'test'
let searchTimeout;

const state = StateManager.init('g2-conference');

/* ─── DOM refs ─── */
const tooltip = document.getElementById('tooltip');
const detailContent = document.getElementById('detailContent');
const detailEmpty = document.getElementById('detailEmpty');
const roomView = document.getElementById('roomView');
const pullView = document.getElementById('pullView');
const pullContent = document.getElementById('pullContent');
const searchResultsView = document.getElementById('searchResultsView');
const searchResults = document.getElementById('searchResults');
const searchInput = document.getElementById('searchInput');
const searchCount = document.getElementById('searchCount');
const daySwitcher = document.getElementById('daySwitcher');
const planLayout = document.querySelector('.plan-layout');
const detailPanel = document.getElementById('detailPanel');

/* ═══════════════════════════════════════════
   DATA LAYER
   ═══════════════════════════════════════════ */

function getRoomDay(roomId, day) {
  const room = EVENT_DATA.rooms[roomId];
  if (!room) return { items: {}, notes: null, crew: null, tags: null };
  const sched = room.schedule || {};
  const dayData = sched[day] || sched.default || {};
  const items = ('items' in dayData) ? dayData.items : (room.defaultItems || {});
  return {
    items: items,
    notes: dayData.notes || null,
    crew: room.crew || null,
    tags: room.tags || null,
  };
}

/** Flatten items object {audio: [...], video: [...]} into a single array with category attached */
function flattenItems(items) {
  const flat = [];
  if (!items) return flat;
  for (const cat of CAT_ORDER) {
    const catItems = items[cat];
    if (!catItems || catItems.length === 0) continue;
    for (const item of catItems) {
      if (typeof item === 'string') {
        flat.push({ name: item, qty: 1, cat });
      } else {
        flat.push({ ...item, cat });
      }
    }
  }
  return flat;
}

function countItems(dayData) {
  const cats = dayData.items || {};
  return Object.values(cats).reduce((sum, arr) => {
    if (!arr) return sum;
    return sum + arr.length;
  }, 0);
}

function getIntensity(count) {
  if (count === 0) return 0;
  if (count <= 2) return 1;
  if (count <= 6) return 2;
  if (count <= 12) return 3;
  return 4;
}

function getProgressIntensity(pct) {
  if (pct === 0) return 0;
  if (pct < 0.25) return 1;
  if (pct < 0.5) return 2;
  if (pct < 0.75) return 3;
  return 4;
}

/* ═══════════════════════════════════════════
   INIT
   ═══════════════════════════════════════════ */

function init() {
  document.getElementById('venueName').textContent = EVENT_DATA.event.venue;
  document.getElementById('venueAddr').textContent = EVENT_DATA.event.address;
  document.title = EVENT_DATA.event.venue + ' — Floor Plan';

  EVENT_DATA.event.days.forEach((day, i) => {
    const btn = document.createElement('button');
    btn.className = 'day-tab' + (day === currentDay ? ' active' : '');
    btn.dataset.day = day;
    btn.setAttribute('role', 'tab');
    btn.setAttribute('aria-selected', day === currentDay);
    const label = EVENT_DATA.event.dayLabels[day] || '';
    btn.innerHTML = `<span class="day-date">${day}</span><span class="day-label">${label}</span>`;
    btn.addEventListener('click', () => setDay(day));
    daySwitcher.appendChild(btn);
  });

  document.querySelectorAll('.room').forEach(el => {
    el.addEventListener('click', () => selectRoom(el));
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectRoom(el); }
    });
  });

  // Populate mobile room selector
  buildRoomSelector();

  document.querySelectorAll('.legend-mode-btn').forEach(btn => {
    btn.addEventListener('click', () => setIntensityMode(btn.dataset.mode));
  });

  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(handleSearch, 120);
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (searchInput.value) {
        searchInput.value = '';
        handleSearch();
        searchInput.blur();
      } else {
        clearSelection();
      }
      return;
    }
    // 1-4 for day switching (when not typing)
    if (document.activeElement !== searchInput && !e.metaKey && !e.ctrlKey) {
      const idx = parseInt(e.key) - 1;
      if (idx >= 0 && idx < EVENT_DATA.event.days.length) {
        setDay(EVENT_DATA.event.days[idx]);
      }
    }
  });

  updateRoomStates();
  renderPullSheet();
  updateProgressRings();
  createRoomStatusBars();
  updateAllStatusBars();
  handleHash();

  // Start live data loading (no-op if LIVE_API_URL is empty)
  DataLoader.init();
}

/* ═══════════════════════════════════════════
   INTENSITY MODE
   ═══════════════════════════════════════════ */

function setIntensityMode(mode) {
  intensityMode = mode;
  document.querySelectorAll('.legend-mode-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });

  const legendTitle = document.getElementById('legendTitle');
  const labels = {
    gear:  { title: 'Gear Load',     levels: ['Empty', 'Light', 'Moderate', 'Heavy', 'Dense'] },
    setup: { title: 'Setup %',       levels: ['0%', '1\u201324%', '25\u201349%', '50\u201374%', '75\u2013100%'] },
    test:  { title: 'Test %',        levels: ['0%', '1\u201324%', '25\u201349%', '50\u201374%', '75\u2013100%'] },
  };
  const cfg = labels[mode];
  legendTitle.textContent = cfg.title;
  document.querySelectorAll('.legend-label').forEach((el, i) => {
    if (cfg.levels[i]) el.textContent = cfg.levels[i];
  });

  const swatches = document.querySelectorAll('.legend-swatch');
  swatches.forEach(sw => {
    sw.className = 'legend-swatch';
    sw.style.background = '';
    sw.style.border = '';
  });
  if (mode === 'gear') {
    swatches.forEach((sw, i) => sw.classList.add('sw-' + i));
  } else if (mode === 'setup') {
    const fills = ['var(--set-0-fill)', 'var(--set-1-fill)', 'var(--set-2-fill)', 'var(--set-3-fill)', 'var(--set-4-fill)'];
    const borders = ['var(--set-0-stroke)', 'var(--set-1-stroke)', 'var(--set-2-stroke)', 'var(--set-3-stroke)', 'var(--set-4-stroke)'];
    swatches.forEach((sw, i) => { sw.style.background = fills[i]; sw.style.border = '1px solid ' + borders[i]; });
  } else {
    const fills = ['var(--test-0-fill)', 'var(--test-1-fill)', 'var(--test-2-fill)', 'var(--test-3-fill)', 'var(--test-4-fill)'];
    const borders = ['var(--test-0-stroke)', 'var(--test-1-stroke)', 'var(--test-2-stroke)', 'var(--test-3-stroke)', 'var(--test-4-stroke)'];
    swatches.forEach((sw, i) => { sw.style.background = fills[i]; sw.style.border = '1px solid ' + borders[i]; });
  }

  updateRoomStates();
  updateAllStatusBars();
}

/* ═══════════════════════════════════════════
   DAY SWITCHING
   ═══════════════════════════════════════════ */

function setDay(day) {
  if (day === currentDay) return;
  currentDay = day;

  daySwitcher.querySelectorAll('.day-tab').forEach(btn => {
    const isActive = btn.dataset.day === day;
    btn.classList.toggle('active', isActive);
    btn.setAttribute('aria-selected', isActive);
    if (isActive) {
      btn.scrollIntoView({ behavior: 'smooth', inline: 'nearest', block: 'nearest' });
    }
  });

  updateRoomStates();
  renderPullSheet();
  updateProgressRings();
  updateAllStatusBars();
  buildRoomSelector();

  if (selectedEl) {
    const rid = selectedEl.dataset.room;
    syncRoomChips(rid);
    renderRoomDetail(rid);
  }

  if (searchInput.value.trim()) {
    handleSearch();
  }

  updateHash();
}

/* ═══════════════════════════════════════════
   ROOM STATE UPDATES
   ═══════════════════════════════════════════ */

function updateRoomStates() {
  const query = searchInput.value.trim().toLowerCase();
  const searchActive = query.length > 0;
  let matchSet = null;

  if (searchActive) {
    matchSet = new Set(searchGear(query).map(r => r.roomId));
  }

  document.querySelectorAll('.room').forEach(el => {
    const roomId = el.dataset.room;
    const dayData = getRoomDay(roomId, currentDay);
    const count = countItems(dayData);
    const flat = flattenItems(dayData.items);

    let intensity;
    if (intensityMode === 'gear') {
      intensity = getIntensity(count);
    } else {
      const type = intensityMode === 'setup' ? 'set' : 'test';
      if (flat.length === 0) {
        intensity = 0;
      } else {
        let done = 0;
        for (let i = 0; i < flat.length; i++) {
          if (state.isChecked(roomId, currentDay, i, type)) done++;
        }
        intensity = getProgressIntensity(done / flat.length);
      }
    }

    el.classList.remove('i0', 'i1', 'i2', 'i3', 'i4');
    el.classList.add('i' + intensity);

    // Flip labels to white on dark fills (heavy/dense in gear mode)
    const needsWhiteText = intensityMode === 'gear' && intensity >= 3;
    const labelColor = needsWhiteText ? '#ffffff' : '';
    const subColor = needsWhiteText ? 'rgba(255,255,255,0.8)' : '';
    // Walk sibling text elements until next .room rect
    let sib = el.nextElementSibling;
    while (sib && !sib.classList.contains('room') && !sib.classList.contains('divider-line')) {
      if (sib.tagName === 'text') {
        if (sib.classList.contains('label-room')) {
          sib.style.fill = labelColor;
        } else if (sib.classList.contains('label-sub') || sib.classList.contains('label-count')) {
          sib.style.fill = subColor;
        }
      }
      sib = sib.nextElementSibling;
    }

    if (intensityMode === 'setup') {
      el.style.fill = `var(--set-${intensity}-fill)`;
      el.style.stroke = `var(--set-${intensity}-stroke)`;
    } else if (intensityMode === 'test') {
      el.style.fill = `var(--test-${intensity}-fill)`;
      el.style.stroke = `var(--test-${intensity}-stroke)`;
    } else {
      el.style.fill = '';
      if (flat.length > 0) {
        const prog = state.getRoomProgress(roomId, currentDay, flat.length);
        const readyPct = (prog.set + prog.test) / (flat.length * 2);
        if (readyPct >= 1) {
          el.style.stroke = 'var(--accent)';
        } else if (readyPct > 0) {
          el.style.stroke = 'var(--status-set)';
        } else {
          el.style.stroke = '';
        }
      } else {
        el.style.stroke = '';
      }
    }

    const countLabel = document.querySelector(`[data-count-for="${roomId}"]`);
    if (countLabel) {
      if (intensityMode === 'gear') {
        countLabel.textContent = count > 0 ? count + (count === 1 ? ' item' : ' items') : '';
      } else {
        const type = intensityMode === 'setup' ? 'set' : 'test';
        if (flat.length > 0) {
          let done = 0;
          for (let i = 0; i < flat.length; i++) {
            if (state.isChecked(roomId, currentDay, i, type)) done++;
          }
          const pct = Math.round(done / flat.length * 100);
          countLabel.textContent = pct + '%';
        } else {
          countLabel.textContent = '';
        }
      }
    }

    const room = EVENT_DATA.rooms[roomId];
    if (room) {
      el.setAttribute('aria-label', room.name + (count > 0 ? ', ' + count + ' items' : ''));
    }

    if (searchActive) {
      el.classList.toggle('search-match', matchSet.has(roomId));
      el.classList.toggle('search-dim', !matchSet.has(roomId));
    } else {
      el.classList.remove('search-match', 'search-dim');
    }
  });
}

/* ═══════════════════════════════════════════
   PROGRESS RINGS
   ═══════════════════════════════════════════ */

function updateProgressRings() {
  const prog = state.getDayProgress(currentDay);
  const pctSet  = prog.total > 0 ? prog.set / prog.total : 0;
  const pctTest = prog.total > 0 ? prog.test / prog.total : 0;
  const pctReady = prog.total > 0 ? (prog.set + prog.test) / (prog.total * 2) : 0;

  document.getElementById('ringSet').style.strokeDashoffset = RING_CIRC * (1 - pctSet);
  document.getElementById('ringTest').style.strokeDashoffset = RING_CIRC * (1 - pctTest);
  document.getElementById('ringReady').style.strokeDashoffset = RING_CIRC * (1 - pctReady);

  document.getElementById('pctSet').textContent = Math.round(pctSet * 100) + '%';
  document.getElementById('pctTest').textContent = Math.round(pctTest * 100) + '%';
  document.getElementById('pctReady').textContent = Math.round(pctReady * 100) + '%';

  // Mobile progress bars
  const mSet = document.getElementById('mprogSet');
  const mTest = document.getElementById('mprogTest');
  if (mSet) {
    mSet.style.width = Math.round(pctSet * 100) + '%';
    document.getElementById('mprogSetPct').textContent = Math.round(pctSet * 100) + '%';
  }
  if (mTest) {
    mTest.style.width = Math.round(pctTest * 100) + '%';
    document.getElementById('mprogTestPct').textContent = Math.round(pctTest * 100) + '%';
  }
}

/* ═══════════════════════════════════════════
   ROOM STATUS BARS (SVG overlay)
   ═══════════════════════════════════════════ */

function svgEl(tag, attrs) {
  const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
  for (const [k, v] of Object.entries(attrs)) el.setAttribute(k, v);
  return el;
}

function createRoomStatusBars() {
  const svg = document.querySelector('.plan-card svg');
  const layer = svgEl('g', { id: 'statusBars' });
  svg.appendChild(layer);

  document.querySelectorAll('.room').forEach(el => {
    const roomId = el.dataset.room;
    const bbox = el.getBBox();

    const barH = 4, gap = 2;
    const barsTotal = barH * 2 + gap; // 10px for both bars
    const margin = Math.min(bbox.width * 0.06, 8);
    const barX = bbox.x + margin;
    const maxW = bbox.width - margin * 2;

    // Find the lowest text label associated with this room
    let lowestTextY = bbox.y;
    let sib = el.nextElementSibling;
    while (sib && !sib.classList.contains('room') && !sib.classList.contains('divider-line')) {
      if (sib.tagName === 'text') {
        const ty = parseFloat(sib.getAttribute('y') || 0);
        if (ty > lowestTextY) lowestTextY = ty;
      }
      sib = sib.nextElementSibling;
    }

    // Space below text descenders to room bottom
    const textBottom = lowestTextY + 6; // 6px for descenders
    const roomBottom = bbox.y + bbox.height;
    const spaceBelow = roomBottom - textBottom;

    // Skip if room too narrow or not enough space for bars + padding
    if (maxW < 24 || spaceBelow < barsTotal + 4) return;

    // Bars flush to bottom, 3px padding
    const barY = roomBottom - barsTotal - 3;

    const g = svgEl('g', {});
    g.dataset.statusFor = roomId;

    g.appendChild(svgEl('rect', { x: barX, y: barY, width: maxW, height: barH, rx: 1.5, class: 'status-track-rect' }));
    const sBar = svgEl('rect', { x: barX, y: barY, width: 0, height: barH, rx: 1.5, class: 'status-set-rect' });
    sBar.dataset.maxW = maxW;
    g.appendChild(sBar);

    g.appendChild(svgEl('rect', { x: barX, y: barY + barH + gap, width: maxW, height: barH, rx: 1.5, class: 'status-track-rect' }));
    const tBar = svgEl('rect', { x: barX, y: barY + barH + gap, width: 0, height: barH, rx: 1.5, class: 'status-test-rect' });
    tBar.dataset.maxW = maxW;
    g.appendChild(tBar);

    layer.appendChild(g);
  });
}

function updateAllStatusBars() {
  document.querySelectorAll('[data-status-for]').forEach(g => {
    const roomId = g.dataset.statusFor;
    const dayData = getRoomDay(roomId, currentDay);
    const flat = flattenItems(dayData.items);
    const total = flat.length;

    if (total === 0) { g.style.opacity = '0'; return; }
    g.style.opacity = '1';

    const prog = state.getRoomProgress(roomId, currentDay, total);

    g.querySelectorAll('.status-set-rect').forEach(bar => {
      bar.setAttribute('width', parseFloat(bar.dataset.maxW) * (prog.set / total));
    });
    g.querySelectorAll('.status-test-rect').forEach(bar => {
      bar.setAttribute('width', parseFloat(bar.dataset.maxW) * (prog.test / total));
    });
  });
}

/* ═══════════════════════════════════════════
   VIEWBOX PAN
   ═══════════════════════════════════════════ */

const FULL_VIEWBOX = { x: 0, y: 0, w: 860, h: 750 };
let currentViewBox = { ...FULL_VIEWBOX };
let zoomAnimId = null;

function animateViewBox(target, duration) {
  const svg = document.querySelector('.plan-card svg');
  if (!svg) return;
  if (zoomAnimId) cancelAnimationFrame(zoomAnimId);

  const start = { ...currentViewBox };
  const t0 = performance.now();

  function tick(now) {
    const elapsed = now - t0;
    const raw = Math.min(elapsed / duration, 1);
    const t = 1 - Math.pow(1 - raw, 3);

    currentViewBox.x = start.x + (target.x - start.x) * t;
    currentViewBox.y = start.y + (target.y - start.y) * t;
    currentViewBox.w = start.w + (target.w - start.w) * t;
    currentViewBox.h = start.h + (target.h - start.h) * t;

    svg.setAttribute('viewBox',
      `${currentViewBox.x.toFixed(1)} ${currentViewBox.y.toFixed(1)} ${currentViewBox.w.toFixed(1)} ${currentViewBox.h.toFixed(1)}`
    );

    if (raw < 1) {
      zoomAnimId = requestAnimationFrame(tick);
    } else {
      zoomAnimId = null;
    }
  }
  zoomAnimId = requestAnimationFrame(tick);
}

function panToRoom(el) {
  const bbox = el.getBBox();
  const cx = bbox.x + bbox.width / 2;
  const cy = bbox.y + bbox.height / 2;
  const centerX = currentViewBox.x + currentViewBox.w / 2;
  const centerY = currentViewBox.y + currentViewBox.h / 2;
  let targetX = currentViewBox.x + (cx - centerX) * 0.6;
  let targetY = currentViewBox.y + (cy - centerY) * 0.6;
  targetX = Math.max(0, Math.min(targetX, FULL_VIEWBOX.w - currentViewBox.w));
  targetY = Math.max(0, Math.min(targetY, FULL_VIEWBOX.h - currentViewBox.h));
  animateViewBox({ x: targetX, y: targetY, w: currentViewBox.w, h: currentViewBox.h }, 350);
}

function panToFull() {
  animateViewBox({ ...FULL_VIEWBOX }, 350);
}

/* ═══════════════════════════════════════════
   ROOM DIMMING
   ═══════════════════════════════════════════ */

function dimOtherRooms(sel) {
  document.querySelectorAll('.room').forEach(el => {
    if (el !== sel) { el.style.opacity = '0.30'; el.classList.add('dimmed'); }
  });
}

function undimAllRooms() {
  document.querySelectorAll('.room').forEach(el => {
    el.style.opacity = ''; el.classList.remove('dimmed');
  });
}

/* ═══════════════════════════════════════════
   SIDEBAR PROGRESS UPDATE (inline after checkbox)
   ═══════════════════════════════════════════ */

function updateDetailProgress(roomId) {
  const dayData = getRoomDay(roomId, currentDay);
  const flat = flattenItems(dayData.items);
  const total = flat.length;
  if (total === 0) return;
  const prog = state.getRoomProgress(roomId, currentDay, total);
  const setPct = Math.round(prog.set / total * 100);
  const testPct = Math.round(prog.test / total * 100);
  const fills = detailContent.querySelectorAll('.compact-fill');
  const pcts = detailContent.querySelectorAll('.compact-pct');
  if (fills[0]) fills[0].style.width = setPct + '%';
  if (fills[1]) fills[1].style.width = testPct + '%';
  if (pcts[0]) pcts[0].textContent = setPct + '%';
  if (pcts[1]) pcts[1].textContent = testPct + '%';
}

/* ═══════════════════════════════════════════
   ROOM DETAIL RENDER (sidebar — full checklist)
   ═══════════════════════════════════════════ */

function renderRoomDetail(roomId) {
  const room = EVENT_DATA.rooms[roomId];
  const dayData = getRoomDay(roomId, currentDay);
  const flat = flattenItems(dayData.items);
  const total = flat.length;
  const items = dayData.items || {};
  const hasCats = Object.keys(items).some(k => items[k] && items[k].length > 0);
  const prog = total > 0 ? state.getRoomProgress(roomId, currentDay, total) : { set: 0, test: 0, total: 0 };

  let html = `<div class="detail-header">${room.name}</div>`;
  html += `<div class="detail-meta">`;
  html += `<span class="detail-type dt-${room.type}">${room.type}</span>`;
  if (total > 0) html += `<span class="detail-count">${total} item${total !== 1 ? 's' : ''}</span>`;
  html += `</div>`;

  const tags = dayData.tags || [];
  if (tags.length > 0) {
    html += `<div class="detail-tags">`;
    for (const [tagType, tagLabel] of tags) {
      html += `<span class="detail-tag tag-${tagType}">${tagLabel}</span>`;
    }
    html += `</div>`;
  }

  if (dayData.crew && tags.length === 0) {
    html += `<div class="detail-crew">Crew: ${dayData.crew}</div>`;
  }

  if (total > 0) {
    const setPct = Math.round(prog.set / total * 100);
    const testPct = Math.round(prog.test / total * 100);
    html += `<div class="compact-progress">`;
    html += `<div class="compact-bar"><span class="compact-label">SET</span><div class="compact-track"><div class="compact-fill" style="width:${setPct}%; background: var(--status-set);"></div></div><span class="compact-pct">${setPct}%</span></div>`;
    html += `<div class="compact-bar"><span class="compact-label">TEST</span><div class="compact-track"><div class="compact-fill" style="width:${testPct}%; background: var(--status-test);"></div></div><span class="compact-pct">${testPct}%</span></div>`;
    html += `</div>`;
  }

  if (hasCats) {
    let globalIdx = 0;
    for (const cat of CAT_ORDER) {
      const catItems = items[cat];
      if (!catItems || catItems.length === 0) continue;
      const meta = CAT_META[cat] || { label: cat, cls: '' };
      html += `<div class="detail-section-label ${meta.cls}">${meta.label}</div>`;

      for (const item of catItems) {
        const isObj = typeof item === 'object';
        const name = isObj ? item.name : item;
        const qty = isObj ? (item.qty || 1) : 1;
        const loc = isObj ? item.loc : null;
        const src = isObj ? item.src : null;
        const note = isObj ? item.note : null;
        const flag = isObj ? item.flag : null;

        const setChecked = state.isChecked(roomId, currentDay, globalIdx, 'set');
        const testChecked = state.isChecked(roomId, currentDay, globalIdx, 'test');

        const subParts = [];
        if (loc) subParts.push(src ? loc + ' \u00b7 ' + src : loc);
        else if (src) subParts.push(src);
        if (note) subParts.push(note);
        const subHtml = subParts.length ? `<div class="item-sub">${subParts.join(' \u2014 ')}</div>` : '';
        const flagHtml = flag ? `<div class="item-flag">${flag}</div>` : '';

        html += `<div class="checklist-row">`;
        html += `<div class="check-col"><div class="check-box set-box${setChecked ? ' checked' : ''}" data-room="${roomId}" data-idx="${globalIdx}" data-type="set"></div><span class="check-label lbl-set">Set</span></div>`;
        html += `<div class="check-col"><div class="check-box test-box${testChecked ? ' checked' : ''}" data-room="${roomId}" data-idx="${globalIdx}" data-type="test"></div><span class="check-label lbl-test">Test</span></div>`;
        html += `<div class="item-info"><div class="item-name">${name}</div>${subHtml}${flagHtml}</div>`;
        html += `<div class="item-qty">${qty > 1 ? '\u00d7' + qty : ''}</div>`;
        html += `</div>`;

        globalIdx++;
      }
    }
  }

  if (dayData.notes) {
    html += `<div class="detail-note">${dayData.notes}</div>`;
  }

  if (!hasCats && !dayData.notes) {
    html += `<div class="detail-note">No gear or notes for this room on ${currentDay}.</div>`;
  }

  detailContent.innerHTML = html;
  detailContent.style.display = '';
  detailEmpty.style.display = 'none';

  detailContent.classList.remove('revealing');
  void detailContent.offsetWidth;
  detailContent.classList.add('revealing');

  detailContent.querySelectorAll('.check-box').forEach(cb => {
    cb.addEventListener('click', () => {
      const rid = cb.dataset.room;
      const idx = parseInt(cb.dataset.idx);
      const type = cb.dataset.type;
      state.toggle(rid, currentDay, idx, type);
      cb.classList.toggle('checked');

      cb.classList.remove('popping');
      void cb.offsetWidth;
      cb.classList.add('popping');

      updateProgressRings();
      updateAllStatusBars();
      updateRoomStates();
      updateDetailProgress(rid);
    });
  });
}

/* ═══════════════════════════════════════════
   ROOM SELECTION
   ═══════════════════════════════════════════ */

/* ── Mobile Room Selector ── */

function buildRoomSelector() {
  const container = document.getElementById('roomSelector');
  container.innerHTML = '';

  // Only show rooms with gear on the current day
  const activeRooms = [];
  for (const [roomId, room] of Object.entries(EVENT_DATA.rooms)) {
    const dayData = getRoomDay(roomId, currentDay);
    const count = countItems(dayData);
    if (count > 0 || (dayData.notes && !dayData.notes.match(/not in use|no gear/i))) {
      activeRooms.push({ roomId, room, count, notes: dayData.notes || '' });
    }
  }

  // Sort: rooms with gear first, then by item count descending
  activeRooms.sort((a, b) => b.count - a.count);

  for (const { roomId, room, count } of activeRooms) {
    const chip = document.createElement('button');
    chip.className = 'room-chip';
    chip.dataset.room = roomId;
    chip.innerHTML = room.name + (count > 0 ? ` <span class="chip-count">${count}</span>` : '');
    chip.addEventListener('click', () => {
      const el = document.querySelector(`.room[data-room="${roomId}"]`);
      if (el) selectRoom(el);
    });
    container.appendChild(chip);
  }
}

function syncRoomChips(activeRoomId) {
  document.querySelectorAll('.room-chip').forEach(chip => {
    chip.classList.toggle('active', chip.dataset.room === activeRoomId);
  });
}

function showMobileDetail() {
  document.getElementById('roomSelector').classList.add('hidden');
  document.getElementById('mobileProgress').classList.add('hidden');
  document.getElementById('mobileViewTabs').classList.add('hidden');
  detailPanel.classList.add('mobile-active');
  document.getElementById('mobileBack').style.display = 'block';
}

function showMobileList() {
  document.getElementById('roomSelector').classList.remove('hidden');
  document.getElementById('mobileProgress').classList.remove('hidden');
  document.getElementById('mobileViewTabs').classList.remove('hidden');
  detailPanel.classList.remove('mobile-active');
  document.getElementById('mobileBack').style.display = 'none';
  // Reset view tabs to "Rooms"
  document.querySelectorAll('.mobile-view-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.mview === 'rooms');
  });
}

document.getElementById('mobileBack').addEventListener('click', () => {
  clearSelection();
});

function clearSelection() {
  if (selectedEl) {
    selectedEl.classList.remove('selected');
  }
  selectedEl = null;

  planLayout.classList.remove('room-selected');
  detailPanel.classList.remove('expanded');
  undimAllRooms();
  syncRoomChips(null);

  if (isMobile()) {
    showMobileList();
  }

  detailContent.classList.remove('revealing');
  detailEmpty.style.display = '';
  detailContent.style.display = 'none';
  if (!isMobile()) panToFull();
  updateHash();
}

function selectRoom(el) {
  const roomId = el.dataset.room;
  if (!EVENT_DATA.rooms[roomId]) return;

  if (selectedEl === el) { clearSelection(); return; }

  if (searchInput.value.trim()) {
    searchInput.value = '';
    handleSearch();
  }

  if (selectedEl) {
    selectedEl.classList.remove('selected');
  }
  el.classList.add('selected');
  selectedEl = el;

  planLayout.classList.add('room-selected');
  detailPanel.classList.add('expanded');
  syncRoomChips(roomId);

  if (isMobile()) {
    showMobileDetail();
  } else {
    dimOtherRooms(el);
    panToRoom(el);
  }

  switchPanel('room');
  renderRoomDetail(roomId);
  updateHash();
}

/* ═══════════════════════════════════════════
   SEARCH
   ═══════════════════════════════════════════ */

function searchGear(query) {
  const q = query.toLowerCase().trim();
  if (!q) return [];

  const results = [];
  for (const [roomId, room] of Object.entries(EVENT_DATA.rooms)) {
    const dayData = getRoomDay(roomId, currentDay);
    const items = dayData.items || {};
    const matches = [];

    const nameMatch = room.name.toLowerCase().includes(q);
    const crewMatch = room.crew && room.crew.toLowerCase().includes(q);
    const noteMatch = dayData.notes && dayData.notes.toLowerCase().includes(q);

    for (const [cat, catItems] of Object.entries(items)) {
      if (!catItems) continue;
      for (const item of catItems) {
        const itemName = typeof item === 'object' ? item.name : item;
        const itemNote = typeof item === 'object' ? (item.note || '') : '';
        if (itemName.toLowerCase().includes(q) || itemNote.toLowerCase().includes(q)) {
          matches.push({ item: itemName, category: cat });
        }
      }
    }

    if (nameMatch || matches.length > 0 || crewMatch || noteMatch) {
      results.push({ roomId, name: room.name, type: room.type, nameMatch, crewMatch, noteMatch, matches });
    }
  }
  return results;
}

function handleSearch() {
  const query = searchInput.value.trim();

  if (!query) {
    searchCount.classList.remove('visible');
    searchResultsView.style.display = 'none';

    if (activePanel === 'room') {
      roomView.style.display = '';
    }

    updateRoomStates();
    return;
  }

  const results = searchGear(query);

  searchCount.textContent = results.length + ' room' + (results.length !== 1 ? 's' : '');
  searchCount.classList.add('visible');

  let html = '';
  if (results.length === 0) {
    html = `<div class="search-results-header">No matches for "${query}" on ${currentDay}</div>`;
  } else {
    html = `<div class="search-results-header">${results.length} room${results.length !== 1 ? 's' : ''} match "${query}"</div>`;
    for (const r of results) {
      html += `<div class="search-result-item" data-room="${r.roomId}">`;
      html += `<span class="search-result-room">${r.name}</span>`;
      if (r.matches.length > 0) {
        html += `<span class="search-result-matches">${r.matches.map(m => m.item).join(', ')}</span>`;
      } else if (r.nameMatch) {
        html += `<span class="search-result-matches">Room name match</span>`;
      } else if (r.crewMatch) {
        html += `<span class="search-result-matches">Crew match</span>`;
      } else if (r.noteMatch) {
        html += `<span class="search-result-matches">Notes match</span>`;
      }
      html += `</div>`;
    }
  }

  searchResults.innerHTML = html;

  if (activePanel === 'room') {
    roomView.style.display = 'none';
    searchResultsView.style.display = '';
  }

  searchResults.querySelectorAll('.search-result-item').forEach(el => {
    el.addEventListener('click', () => {
      const roomEl = document.querySelector(`.room[data-room="${el.dataset.room}"]`);
      if (roomEl) selectRoom(roomEl);
    });
  });

  updateRoomStates();
}

/* ═══════════════════════════════════════════
   PANEL SWITCHING
   ═══════════════════════════════════════════ */

function switchPanel(view) {
  // Full view toggle
  if (view === 'full') {
    planLayout.classList.toggle('full-view');
    document.querySelectorAll('.panel-tab').forEach(tab => {
      if (tab.dataset.view === 'full') {
        tab.classList.toggle('active', planLayout.classList.contains('full-view'));
      }
    });
    return;
  }

  planLayout.classList.remove('full-view');
  activePanel = view;

  document.querySelectorAll('.panel-tab').forEach(tab => {
    if (tab.dataset.view !== 'full') {
      tab.classList.toggle('active', tab.dataset.view === view);
    } else {
      tab.classList.remove('active');
    }
  });

  roomView.style.display = view === 'room' && !searchInput.value.trim() ? '' : 'none';
  searchResultsView.style.display = view === 'room' && searchInput.value.trim() ? '' : 'none';
  pullView.style.display = view === 'pull' ? '' : 'none';

  if (view === 'pull') {
    renderPullSheet();
  }
}

document.querySelectorAll('.panel-tab').forEach(tab => {
  tab.addEventListener('click', () => switchPanel(tab.dataset.view));
});

/* ═══════════════════════════════════════════
   PULL SHEET
   ═══════════════════════════════════════════ */

function renderPullSheet() {
  const day = currentDay;
  const dayLabel = EVENT_DATA.event.dayLabels[day] || '';
  const cats = {};
  let totalItems = 0;
  let activeRooms = 0;

  for (const [roomId, room] of Object.entries(EVENT_DATA.rooms)) {
    const dayData = getRoomDay(roomId, day);
    const items = dayData.items || {};
    const hasItems = Object.values(items).some(arr => arr && arr.length > 0);

    if (hasItems) activeRooms++;

    let flatIdx = 0;
    for (const cat of CAT_ORDER) {
      const catItems = items[cat];
      if (!catItems || catItems.length === 0) continue;
      if (!cats[cat]) cats[cat] = {};

      for (const item of catItems) {
        const itemName = typeof item === 'object' ? item.name : item;
        const qty = typeof item === 'object' ? (item.qty || 1) : 1;
        const key = itemName + (qty > 1 ? ' \u00d7' + qty : '');

        if (!cats[cat][key]) cats[cat][key] = [];
        cats[cat][key].push({
          roomName: room.name,
          roomId,
          flatIdx,
          setDone: state.isChecked(roomId, day, flatIdx, 'set'),
          testDone: state.isChecked(roomId, day, flatIdx, 'test'),
        });
        totalItems++;
        flatIdx++;
      }
    }
  }

  let html = `<div class="pull-header">`;
  html += `<div class="pull-title">Pull Sheet</div>`;
  html += `<div class="pull-stats">${day} ${dayLabel} &middot; ${activeRooms} room${activeRooms !== 1 ? 's' : ''} &middot; ${totalItems} items</div>`;
  html += `</div>`;

  if (totalItems === 0) {
    html += `<div class="detail-note">No gear assigned for this day.</div>`;
  } else {
    for (const cat of CAT_ORDER) {
      if (!cats[cat]) continue;
      const items = cats[cat];
      const catCount = Object.values(items).reduce((sum, entries) => sum + entries.length, 0);
      const meta = CAT_META[cat] || { label: cat, cls: '' };

      html += `<div class="detail-section-label ${meta.cls}">${meta.label} (${catCount})</div>`;
      for (const [itemKey, entries] of Object.entries(items)) {
        for (const entry of entries) {
          const setClass = entry.setDone ? 'set-done' : '';
          const testClass = entry.testDone ? 'test-done' : '';

          html += `<div class="pull-item ${meta.cls}">`;
          html += `<div class="pull-check ${setClass}" title="SET"></div>`;
          html += `<div class="pull-check ${testClass}" title="TEST"></div>`;
          html += `<span class="pull-item-name">${itemKey}</span>`;
          html += `<span class="pull-item-rooms">${entry.roomName}</span>`;
          html += `</div>`;
        }
      }
    }
  }

  pullContent.innerHTML = html;
}

/* ═══════════════════════════════════════════
   TOOLTIP
   ═══════════════════════════════════════════ */

function showTooltip(el, e) {
  const roomId = el.dataset.room;
  const room = EVENT_DATA.rooms[roomId];
  if (!room) return;
  const dayData = getRoomDay(roomId, currentDay);
  const total = countItems(dayData);
  const flat = flattenItems(dayData.items);

  let text = room.name;
  if (total > 0) {
    text += ' \u00b7 ' + total + ' items';
    const prog = state.getRoomProgress(roomId, currentDay, flat.length);
    if (prog.set > 0 || prog.test > 0) {
      text += ' \u00b7 ' + Math.round((prog.set + prog.test) / (prog.total * 2) * 100) + '% ready';
    }
  }
  tooltip.textContent = text;
  tooltip.classList.add('visible');
  positionTooltip(e);
}

function positionTooltip(e) {
  tooltip.style.left = (e.clientX + 12) + 'px';
  tooltip.style.top = (e.clientY - 30) + 'px';
}

function hideTooltip() {
  tooltip.classList.remove('visible');
}

/* ═══════════════════════════════════════════
   URL HASH
   ═══════════════════════════════════════════ */

function updateHash() {
  const parts = [];
  if (currentDay !== EVENT_DATA.event.defaultDay) {
    parts.push(currentDay.replace('/', '-'));
  }
  if (selectedEl) {
    parts.push(selectedEl.dataset.room);
  }
  const hash = parts.join('/');
  history.replaceState(null, '', hash ? '#' + hash : location.pathname);
}

function handleHash() {
  const hash = location.hash.replace('#', '');
  if (!hash) return;

  const parts = hash.split('/');
  let day = null;
  let roomId = null;

  for (const part of parts) {
    const dayStr = part.replace('-', '/');
    if (EVENT_DATA.event.days.includes(dayStr)) {
      day = dayStr;
    }
    else if (EVENT_DATA.rooms[part]) {
      roomId = part;
    }
  }

  if (day) setDay(day);

  if (roomId) {
    const el = document.querySelector(`[data-room="${roomId}"]`);
    if (el) {
      selectRoom(el);
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
}

window.addEventListener('hashchange', handleHash);

/* ═══════════════════════════════════════════
   MOBILE VIEW MANAGEMENT
   ═══════════════════════════════════════════ */

const isMobile = () => window.matchMedia('(max-width: 860px)').matches;

// Mobile view tabs: switch between Room list and Pull Sheet from the list view
document.querySelectorAll('.mobile-view-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const view = tab.dataset.mview;
    document.querySelectorAll('.mobile-view-tab').forEach(t => t.classList.toggle('active', t === tab));

    if (view === 'pull') {
      // Show pull sheet in the detail panel
      document.getElementById('roomSelector').classList.add('hidden');
      detailPanel.classList.add('mobile-active');
      document.getElementById('mobileBack').style.display = 'none';
      switchPanel('pull');
    } else {
      // Show room list
      detailPanel.classList.remove('mobile-active');
      document.getElementById('roomSelector').classList.remove('hidden');
      if (selectedEl) clearSelection();
    }
  });
});

/* ─── GO ─── */
init();

/* ═══════════════════════════════════════════
   DAY STRIP — native scroll (mobile) + drag (desktop)
   ═══════════════════════════════════════════ */

(function() {
  const strip = daySwitcher;

  // No-op: setDay calls this but native scroll handles positioning
  window._centerDayTab = function() {};

  // Desktop: mouse drag-to-scroll (browsers don't natively drag-scroll divs)
  if (window.innerWidth > 860) {
    let startX, startScroll, dragging = false, moved = false;

    strip.addEventListener('mousedown', (e) => {
      startX = e.clientX;
      startScroll = strip.scrollLeft;
      dragging = true;
      moved = false;
      strip.style.cursor = 'grabbing';
      e.preventDefault();
    });

    window.addEventListener('mousemove', (e) => {
      if (!dragging) return;
      const dx = e.clientX - startX;
      if (Math.abs(dx) > 5) moved = true;
      strip.scrollLeft = startScroll - dx;
    });

    window.addEventListener('mouseup', () => {
      if (!dragging) return;
      dragging = false;
      strip.style.cursor = '';
    });

    strip.addEventListener('click', (e) => {
      if (moved) { e.stopPropagation(); e.preventDefault(); moved = false; }
    }, true);
  }
})();

</script>
</body>
</html>
